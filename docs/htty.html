<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>htty API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{  --pdoc-background:#212529;}.pdoc{  --text:#f7f7f7;  --muted:#9d9d9d;  --link:#58a6ff;  --link-hover:#3989ff;  --code:#1a1a1a;  --active:#555;  --accent:#1a1a1a;  --accent2:#555;  --nav-hover:rgba(0, 0, 0, 0.1);  --name:#9DCDFF;  --def:#0cdd0c;  --annotation:#00c037;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div><h1>htty</h1>   
    <h2>API</h2>
        <ul class="memberlist">
            <li>
                    <a class="function" href="#terminal_session">terminal_session</a>
            </li>
            <li>
                    <a class="function" href="#run">run</a>
            </li>
            <li>
                    <a class="class" href="#HtWrapper">HtWrapper</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#HtWrapper.ht">ht</a>
                        </li>
                        <li>
                                <a class="variable" href="#HtWrapper.cmd">cmd</a>
                        </li>
                        <li>
                                <a class="function" href="#HtWrapper.get_output">get_output</a>
                        </li>
                        <li>
                                <a class="function" href="#HtWrapper.send_keys">send_keys</a>
                        </li>
                        <li>
                                <a class="function" href="#HtWrapper.snapshot">snapshot</a>
                        </li>
                        <li>
                                <a class="function" href="#HtWrapper.exit">exit</a>
                        </li>
                        <li>
                                <a class="function" href="#HtWrapper.expect">expect</a>
                        </li>
                        <li>
                                <a class="function" href="#HtWrapper.expect_absent">expect_absent</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ProcessController">ProcessController</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ProcessController.__init__">ProcessController</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessController.exit">exit</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessController.terminate">terminate</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessController.kill">kill</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessController.wait">wait</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessController.poll">poll</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessController.pid">pid</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessController.exit_code">exit_code</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessController.completed">completed</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SnapshotResult">SnapshotResult</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SnapshotResult.__init__">SnapshotResult</a>
                        </li>
                        <li>
                                <a class="variable" href="#SnapshotResult.text">text</a>
                        </li>
                        <li>
                                <a class="variable" href="#SnapshotResult.html">html</a>
                        </li>
                        <li>
                                <a class="variable" href="#SnapshotResult.raw_seq">raw_seq</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#__version__">__version__</a>
            </li>
    </ul>

<h3><a href="./htty-core/htty_core.html">htty-core</a></h3>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
htty    </h1>

                        <div class="docstring"><p>htty - a wrapper around <a href="https://github.com/andyk/ht">ht</a></p>

<p>Some terminal applications don't make it easy to capture their output in a human-readable way.
Here's vim's startup screen:</p>

<pre><code>~                       VIM - Vi IMproved
~                       version 9.1.1336
~                   by Bram Moolenaar et al.
~          Vim is open source and freely distributable
~
~                 Help poor children in Uganda!
</code></pre>

<p>If you capture vim's ouput directly, you won't get the nicely formatted text you see above.
Instead, you'll get raw ANSI escape sequences.</p>

<pre><code>Vi IMproved[6;37Hversion 9.0.2136[7;33Hby Bram Moolenaar et al.[8;24HVim is open source and freely distributable[10;32HHelp poor children in Uganda!
</code></pre>

<p>htty makes it possible to get a human-friendly string representing the contents of a terminal, without having an actual graphical terminal emulator in the loop.</p>

<p>To do this, it connects processes (like vim) to a <a href="https://man7.org/linux/man-pages/man7/pty.7.html">pseudoterminal interface</a> which directs output to an ANSI interpreter.
Most ANSI interpreters are involved with putting characters on a screen for humans to view directly, but this one is headless, so the text is stored internally for later reference.</p>

<p>htty lets you control the underlying process and take snapshots of the headless terminal's contents at times when you expect it to be interesting.
This can be handy for testing, like when you want to assert that the user's terminal looks a certain way, or for when you're expecting large subprocess output and you want to show your user only a certain part of it.
(This can be especially useful if your user is an AI and you're being charged per-token.)</p>

<p>It's a bit like a zoomed-out grep:
Instead of finding lines of a file, it finds snapshots of a terminal session.</p>

<h1 id="library-usage">Library Usage</h1>

<p>The <code><a href="#terminal_session">terminal_session</a></code> context manager yields a <code><a href="#HtWrapper">HtWrapper</a></code> object which has methods for communicating with the underlying <code>ht</code> process.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">htty</span><span class="w"> </span><span class="kn">import</span> <span class="n">Press</span><span class="p">,</span> <span class="n">terminal_session</span>

<span class="c1"># start an interactive bourne shell in a small headless terminal</span>
<span class="k">with</span> <span class="n">terminal_session</span><span class="p">(</span><span class="s2">&quot;sh -i&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="k">as</span> <span class="n">sh</span><span class="p">:</span>

    <span class="c1"># print enough so that the prompt is at the bottom of the screen</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">([</span><span class="sa">r</span><span class="s2">&quot;printf &#39;\n\n\n\nhello world\n&#39;&quot;</span><span class="p">,</span> <span class="n"><a href="#Press.ENTER">Press.ENTER</a></span><span class="p">])</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
    <span class="n">hello</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>

    <span class="c1"># clear the terminal</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">([</span><span class="s2">&quot;clear&quot;</span><span class="p">,</span> <span class="n"><a href="#Press.ENTER">Press.ENTER</a></span><span class="p">])</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">expect_absent</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;\$&quot;</span><span class="p">)</span>
    <span class="n">cleared</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>

<span class="c1"># assert correct placement</span>
<span class="k">assert</span> <span class="n">hello</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="s2">&quot;      &quot;</span><span class="p">,</span> <span class="c1"># line wrap after 6 chars</span>
    <span class="s2">&quot;hello &quot;</span><span class="p">,</span>
    <span class="s2">&quot;world &quot;</span><span class="p">,</span>
    <span class="s2">&quot;$     &quot;</span><span class="p">,</span> <span class="c1"># four rows high</span>
<span class="p">])</span>

<span class="c1"># assert that clear... cleared</span>
<span class="k">assert</span> <span class="n">cleared</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="s2">&quot;$     &quot;</span><span class="p">,</span>
    <span class="s2">&quot;      &quot;</span><span class="p">,</span>
    <span class="s2">&quot;      &quot;</span><span class="p">,</span>
    <span class="s2">&quot;      &quot;</span><span class="p">,</span>
<span class="p">])</span>
</code></pre>
</div>

<p>It's a good idea to <code>expect</code> something before you take a snapshot, otherwise the snapshot might happen before the child process has fully arrived at the state you're trying to capture.</p>

<h1 id="command-line-usage">Command Line Usage</h1>

<p>Unlike the <code><a href="">htty</a></code> python library, the <code><a href="">htty</a></code> command accepts all of its instructions before it starts.
It will do the following:</p>

<ol>
<li>run all instruction, printing snapshots along the way</li>
<li>terminate the child process</li>
<li>exit</li>
</ol>

<p>If you're looking for something that doesn't clean the process up afterwards, consider one of these:</p>

<ul>
<li>run  <a href="https://github.com/andyk/ht?tab=readme-ov-file#usage">ht</a> of <code><a href="">htty</a></code></li>
<li>use <code><a href="">htty</a></code> as a python library</li>
<li>other terminal emulator libraries such as <a href="https://github.com/selectel/pyte">pyte</a></li>
</ul>

<pre><code>$ htty --help
usage: htty [-h] [-r ROWS] [-c COLS] [-k KEYS] [-s] [-d DELIMITER] [--debug]
            [--expect EXPECT] [--expect-absent EXPECT_ABSENT] [--version]
            [command ...]

Run a command with ht terminal emulation (synchronous mode)

positional arguments:
  command               Command to run (must be preceded by --)

options:
  -h, --help            show this help message and exit
  -r ROWS, --rows ROWS  Number of terminal rows (default: 20)
  -c COLS, --cols COLS  Number of terminal columns (default: 50)
  -k KEYS, --keys KEYS  Send keys to the terminal. Can be used multiple times.
  -s, --snapshot        Take a snapshot of terminal output. Can be used
                        multiple times.
  -d DELIMITER, --delimiter DELIMITER
                        Delimiter for parsing keys (default: ',')
  --debug               Enable debug mode: show ht events and subscribe to
                        debug events
  --expect EXPECT       Wait for a regex pattern to appear in the terminal
                        output. Can be used multiple times.
  --expect-absent EXPECT_ABSENT
                        Wait for a regex pattern to disappear from the
                        terminal output. Can be used multiple times.
  --version             show program's version number and exit

Examples:
  htty -- echo hello
  htty -k "hello,Enter" -s -- vim
  htty -r 30 -c 80 -s -k "ihello,Escape" -s -- vim

The -k/--keys, -s/--snapshot, --expect, and --expect-absent options can be used multiple times and will be
processed in order.
</code></pre>

<p>The <code>sl</code> command animates an ascii-art train engine driving from right to left across your terminal.
Near the middle of the engine are some <code>I</code>'s an further back is a <code>Y</code>.
<code><a href="">htty</a></code> can use the appearance and dissapearance of these characters to trigger snapshots of the train.</p>

<p>The command below wraps <code>sl</code>, and captures two snapshots (triggered by Y appearing and I dissapering).
 ints them to stdout with a '----' to indicate the end of each snapshot.</p>

<pre><code>$ htty -r 15 -c 50 --expect Y --snapshot --expect-absent I --snapshot -- sl

                    (@@@)
                 ====        ________
             _D _|  |_______/        \__I_I_____==
              |(_)---  |   H\________/ |   |
              /     |  |   H  |  |     |   |
             |      |  |   H  |__-----------------
             | ________|___H__/__|_____/[][]~\____
             |/ |   |-----------I_____I [][] []  D
           __/ =| o |=-~~\  /~~\  /~~\  /~~\ ____Y
            |/-=|___|=   O=====O=====O=====O|_____
             \_/      \__/  \__/  \__/  \__/



----


      ___________
_===__|_________|
     =|___ ___|      _________________
      ||_| |_||     _|                \_____A
------| [___] |   =|                        |
______|       |   -|                        |
  D   |=======|____|________________________|_
__Y___________|__|__________________________|_
___/~\___/          |_D__D__D_|  |_D__D__D_|
   \_/               \_/   \_/    \_/   \_/



----
</code></pre>

<p>Warning: if you don't include an <code>--expect</code>, it's likely that your first snapshot will be empty because it happens before the command can get around to producing any output.</p>
</div>

                        <input id="mod-htty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-htty-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">htty - a wrapper around [ht](https://github.com/andyk/ht)</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">Some terminal applications don&#39;t make it easy to capture their output in a human-readable way.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">Here&#39;s vim&#39;s startup screen:</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">```</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">~                       VIM - Vi IMproved</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">~                       version 9.1.1336</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">~                   by Bram Moolenaar et al.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">~          Vim is open source and freely distributable</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">~</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">~                 Help poor children in Uganda!</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">```</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">If you capture vim&#39;s ouput directly, you won&#39;t get the nicely formatted text you see above.</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">Instead, you&#39;ll get raw ANSI escape sequences.</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">```</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">Vi IMproved[6;37Hversion 9.0.2136[7;33Hby Bram Moolenaar et al.[8;24HVim is open source and freely distributable[10;32HHelp poor children in Uganda!</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">```</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">htty makes it possible to get a human-friendly string representing the contents of a terminal, without having an actual graphical terminal emulator in the loop.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">To do this, it connects processes (like vim) to a [pseudoterminal interface](https://man7.org/linux/man-pages/man7/pty.7.html) which directs output to an ANSI interpreter.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">Most ANSI interpreters are involved with putting characters on a screen for humans to view directly, but this one is headless, so the text is stored internally for later reference.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">htty lets you control the underlying process and take snapshots of the headless terminal&#39;s contents at times when you expect it to be interesting.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">This can be handy for testing, like when you want to assert that the user&#39;s terminal looks a certain way, or for when you&#39;re expecting large subprocess output and you want to show your user only a certain part of it.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">(This can be especially useful if your user is an AI and you&#39;re being charged per-token.)</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">It&#39;s a bit like a zoomed-out grep:</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">Instead of finding lines of a file, it finds snapshots of a terminal session.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd"># Library Usage</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">The `terminal_session` context manager yields a `HtWrapper` object which has methods for communicating with the underlying `ht` process.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">```python</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">from htty import Press, terminal_session</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd"># start an interactive bourne shell in a small headless terminal</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">with terminal_session(&quot;sh -i&quot;, rows=4, cols=6) as sh:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    # print enough so that the prompt is at the bottom of the screen</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    sh.send_keys([r&quot;printf &#39;\\n\\n\\n\\nhello world\\n&#39;&quot;, Press.ENTER])</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    sh.expect(&quot;world&quot;)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    hello = sh.snapshot()</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    # clear the terminal</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    sh.send_keys([&quot;clear&quot;, Press.ENTER])</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    sh.expect_absent(&quot;world&quot;)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    sh.expect(&quot;\\$&quot;)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    cleared = sh.snapshot()</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd"># assert correct placement</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">assert hello.text == &#39;\\n&#39;.join([</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    &quot;      &quot;, # line wrap after 6 chars</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    &quot;hello &quot;,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    &quot;world &quot;,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    &quot;$     &quot;, # four rows high</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">])</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd"># assert that clear... cleared</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">assert cleared.text == &#39;\\n&#39;.join([</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    &quot;$     &quot;,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    &quot;      &quot;,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">    &quot;      &quot;,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">    &quot;      &quot;,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">])</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">```</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">It&#39;s a good idea to `expect` something before you take a snapshot, otherwise the snapshot might happen before the child process has fully arrived at the state you&#39;re trying to capture.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd"># Command Line Usage</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">Unlike the `htty` python library, the `htty` command accepts all of its instructions before it starts.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">It will do the following:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">1. run all instruction, printing snapshots along the way</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">2. terminate the child process</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">3. exit</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">If you&#39;re looking for something that doesn&#39;t clean the process up afterwards, consider one of these:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd"> - run  [ht](https://github.com/andyk/ht?tab=readme-ov-file#usage) of `htty`</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd"> - use `htty` as a python library</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd"> - other terminal emulator libraries such as [pyte](https://github.com/selectel/pyte)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">```</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">$ htty --help</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">Error running command: Command '['htty', '--help</span>']' returned non-zero exit status 2.
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">```</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">The `sl` command animates an ascii-art train engine driving from right to left across your terminal.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">Near the middle of the engine are some `I`&#39;s an further back is a `Y`.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">`htty` can use the appearance and dissapearance of these characters to trigger snapshots of the train.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">The command below wraps `sl`, and captures two snapshots (triggered by Y appearing and I dissapering).</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd"> ints them to stdout with a &#39;----&#39; to indicate the end of each snapshot.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">```</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">$ htty -r 15 -c 50 --expect Y --snapshot --expect-absent I --snapshot -- sl</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">                    (@@@)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">                 ====        ________</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">             _D _|  |_______/        \\__I_I_____==</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">              |(_)---  |   H\\________/ |   |</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">              /     |  |   H  |  |     |   |</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">             |      |  |   H  |__-----------------</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">             | ________|___H__/__|_____/[][]~\\____</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">             |/ |   |-----------I_____I [][] []  D</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">           __/ =| o |=-~~\\  /~~\\  /~~\\  /~~\\ ____Y</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">            |/-=|___|=   O=====O=====O=====O|_____</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">             \\_/      \\__/  \\__/  \\__/  \\__/</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">----</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">      ___________</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">_===__|_________|</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">     =|___ ___|      _________________</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">      ||_| |_||     _|                \\_____A</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">------| [___] |   =|                        |</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">______|       |   -|                        |</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">  D   |=======|____|________________________|_</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">__Y___________|__|__________________________|_</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">___/~\\___/          |_D__D__D_|  |_D__D__D_|</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">   \\_/               \\_/   \\_/    \\_/   \\_/</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">----</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">```</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">Warning: if you don&#39;t include an `--expect`, it&#39;s likely that your first snapshot will be empty because it happens before the command can get around to producing any output.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">htty.keys</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">keys</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">htty.ht</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">HtWrapper</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="n">ProcessController</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="n">SnapshotResult</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    <span class="n">run</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="n">terminal_session</span><span class="p">,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">htty.keys</span><span class="w"> </span><span class="kn">import</span> <span class="n">Press</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="c1"># [[[cog</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="c1"># import os</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="c1"># cog.out(f&#39;__version__ = &quot;{os.environ[&quot;HTTY_VERSION&quot;]}&quot;&#39;)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="c1"># ]]]</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.2.28&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="c1"># [[[end]]]</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>    <span class="s2">&quot;terminal_session&quot;</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="s2">&quot;run&quot;</span><span class="p">,</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>    <span class="s2">&quot;HtWrapper&quot;</span><span class="p">,</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="s2">&quot;ProcessController&quot;</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="s2">&quot;SnapshotResult&quot;</span><span class="p">,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>    <span class="s2">&quot;Press&quot;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="s2">&quot;keys&quot;</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="s2">&quot;__version__&quot;</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="terminal_session">
                            <input id="terminal_session-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-contextmanager">@contextmanager</div>

        <span class="def">def</span>
        <span class="name">terminal_session</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">command</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="s1">&#39;run this command (as a subprocess of ht)&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">rows</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s1">&#39;number of rows for the headless terminal (default: 30)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cols</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s1">&#39;number of columns for the headless terminal (default: 60)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">logger</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">],</span> <span class="s1">&#39;callers can override the default logger with their own&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">extra_subscribes</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">htty_core</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">HtEvent</span><span class="p">]],</span> <span class="s1">&#39;additional event types to subscribe to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Iterator</span><span class="p">[</span><span class="n"><a href="#HtWrapper">HtWrapper</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="terminal_session-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#terminal_session"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="terminal_session-584"><a href="#terminal_session-584"><span class="linenos">584</span></a><span class="nd">@contextmanager</span>
</span><span id="terminal_session-585"><a href="#terminal_session-585"><span class="linenos">585</span></a><span class="k">def</span><span class="w"> </span><span class="nf">terminal_session</span><span class="p">(</span>
</span><span id="terminal_session-586"><a href="#terminal_session-586"><span class="linenos">586</span></a>    <span class="n">command</span><span class="p">:</span> <span class="n">Command</span><span class="p">,</span>
</span><span id="terminal_session-587"><a href="#terminal_session-587"><span class="linenos">587</span></a>    <span class="n">rows</span><span class="p">:</span> <span class="n">Rows</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="terminal_session-588"><a href="#terminal_session-588"><span class="linenos">588</span></a>    <span class="n">cols</span><span class="p">:</span> <span class="n">Cols</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="terminal_session-589"><a href="#terminal_session-589"><span class="linenos">589</span></a>    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="terminal_session-590"><a href="#terminal_session-590"><span class="linenos">590</span></a>    <span class="n">extra_subscribes</span><span class="p">:</span> <span class="n">ExtraSubscribes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="terminal_session-591"><a href="#terminal_session-591"><span class="linenos">591</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">HtWrapper</span><span class="p">]:</span>
</span><span id="terminal_session-592"><a href="#terminal_session-592"><span class="linenos">592</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="terminal_session-593"><a href="#terminal_session-593"><span class="linenos">593</span></a><span class="sd">    The terminal_session context manager is a wrapper around `run` which ensures that the underlying process</span>
</span><span id="terminal_session-594"><a href="#terminal_session-594"><span class="linenos">594</span></a><span class="sd">    gets cleaned up:</span>
</span><span id="terminal_session-595"><a href="#terminal_session-595"><span class="linenos">595</span></a>
</span><span id="terminal_session-596"><a href="#terminal_session-596"><span class="linenos">596</span></a><span class="sd">    ```python</span>
</span><span id="terminal_session-597"><a href="#terminal_session-597"><span class="linenos">597</span></a><span class="sd">    with terminal_session(&quot;some command&quot;) as proc:</span>
</span><span id="terminal_session-598"><a href="#terminal_session-598"><span class="linenos">598</span></a><span class="sd">        # interact with the running command here</span>
</span><span id="terminal_session-599"><a href="#terminal_session-599"><span class="linenos">599</span></a><span class="sd">        assert proc.exit_code is not None</span>
</span><span id="terminal_session-600"><a href="#terminal_session-600"><span class="linenos">600</span></a><span class="sd">        s = proc.snapshot()</span>
</span><span id="terminal_session-601"><a href="#terminal_session-601"><span class="linenos">601</span></a>
</span><span id="terminal_session-602"><a href="#terminal_session-602"><span class="linenos">602</span></a><span class="sd">    # htty terminates your command on context exit</span>
</span><span id="terminal_session-603"><a href="#terminal_session-603"><span class="linenos">603</span></a><span class="sd">    assert proc.exit_code is None</span>
</span><span id="terminal_session-604"><a href="#terminal_session-604"><span class="linenos">604</span></a><span class="sd">    assert &quot;hello world&quot; in proc.snapshot()</span>
</span><span id="terminal_session-605"><a href="#terminal_session-605"><span class="linenos">605</span></a><span class="sd">    ```</span>
</span><span id="terminal_session-606"><a href="#terminal_session-606"><span class="linenos">606</span></a>
</span><span id="terminal_session-607"><a href="#terminal_session-607"><span class="linenos">607</span></a><span class="sd">    Its usage is otherwise the same as `run`.</span>
</span><span id="terminal_session-608"><a href="#terminal_session-608"><span class="linenos">608</span></a><span class="sd">    Like `run` it returns a `HtWrapper`.</span>
</span><span id="terminal_session-609"><a href="#terminal_session-609"><span class="linenos">609</span></a>
</span><span id="terminal_session-610"><a href="#terminal_session-610"><span class="linenos">610</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="terminal_session-611"><a href="#terminal_session-611"><span class="linenos">611</span></a>
</span><span id="terminal_session-612"><a href="#terminal_session-612"><span class="linenos">612</span></a>    <span class="n">proc</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span>
</span><span id="terminal_session-613"><a href="#terminal_session-613"><span class="linenos">613</span></a>        <span class="n">command</span><span class="p">,</span>
</span><span id="terminal_session-614"><a href="#terminal_session-614"><span class="linenos">614</span></a>        <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
</span><span id="terminal_session-615"><a href="#terminal_session-615"><span class="linenos">615</span></a>        <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span>
</span><span id="terminal_session-616"><a href="#terminal_session-616"><span class="linenos">616</span></a>        <span class="n">no_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="terminal_session-617"><a href="#terminal_session-617"><span class="linenos">617</span></a>        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
</span><span id="terminal_session-618"><a href="#terminal_session-618"><span class="linenos">618</span></a>        <span class="n">extra_subscribes</span><span class="o">=</span><span class="n">extra_subscribes</span><span class="p">,</span>
</span><span id="terminal_session-619"><a href="#terminal_session-619"><span class="linenos">619</span></a>    <span class="p">)</span>
</span><span id="terminal_session-620"><a href="#terminal_session-620"><span class="linenos">620</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="terminal_session-621"><a href="#terminal_session-621"><span class="linenos">621</span></a>        <span class="k">yield</span> <span class="n">proc</span>
</span><span id="terminal_session-622"><a href="#terminal_session-622"><span class="linenos">622</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="terminal_session-623"><a href="#terminal_session-623"><span class="linenos">623</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="terminal_session-624"><a href="#terminal_session-624"><span class="linenos">624</span></a>            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
</span><span id="terminal_session-625"><a href="#terminal_session-625"><span class="linenos">625</span></a>                <span class="n">proc</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="terminal_session-626"><a href="#terminal_session-626"><span class="linenos">626</span></a>                <span class="n">proc</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_SUBPROCESS_WAIT_TIMEOUT</span><span class="p">)</span>
</span><span id="terminal_session-627"><a href="#terminal_session-627"><span class="linenos">627</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="terminal_session-628"><a href="#terminal_session-628"><span class="linenos">628</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="terminal_session-629"><a href="#terminal_session-629"><span class="linenos">629</span></a>                <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
</span><span id="terminal_session-630"><a href="#terminal_session-630"><span class="linenos">630</span></a>                    <span class="n">proc</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="terminal_session-631"><a href="#terminal_session-631"><span class="linenos">631</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="terminal_session-632"><a href="#terminal_session-632"><span class="linenos">632</span></a>                <span class="k">pass</span>
</span><span id="terminal_session-633"><a href="#terminal_session-633"><span class="linenos">633</span></a>
</span><span id="terminal_session-634"><a href="#terminal_session-634"><span class="linenos">634</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="terminal_session-635"><a href="#terminal_session-635"><span class="linenos">635</span></a>            <span class="n">proc</span><span class="o">.</span><span class="n">ht</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="terminal_session-636"><a href="#terminal_session-636"><span class="linenos">636</span></a>            <span class="n">proc</span><span class="o">.</span><span class="n">ht</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_SUBPROCESS_WAIT_TIMEOUT</span><span class="p">)</span>
</span><span id="terminal_session-637"><a href="#terminal_session-637"><span class="linenos">637</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="terminal_session-638"><a href="#terminal_session-638"><span class="linenos">638</span></a>            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="terminal_session-639"><a href="#terminal_session-639"><span class="linenos">639</span></a>                <span class="n">proc</span><span class="o">.</span><span class="n">ht</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>The terminal_session context manager is a wrapper around <code><a href="#run">run</a></code> which ensures that the underlying process
gets cleaned up:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">with</span> <span class="n">terminal_session</span><span class="p">(</span><span class="s2">&quot;some command&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
    <span class="c1"># interact with the running command here</span>
    <span class="k">assert</span> <span class="n">proc</span><span class="o">.</span><span class="n">exit_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>

<span class="c1"># htty terminates your command on context exit</span>
<span class="k">assert</span> <span class="n">proc</span><span class="o">.</span><span class="n">exit_code</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="s2">&quot;hello world&quot;</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</code></pre>
</div>

<p>Its usage is otherwise the same as <code><a href="#run">run</a></code>.
Like <code><a href="#run">run</a></code> it returns a <code><a href="#HtWrapper">HtWrapper</a></code>.</p>
</div>


                </section>
                <section id="run">
                            <input id="run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">command</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="s1">&#39;run this command (as a subprocess of ht)&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">rows</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s1">&#39;number of rows for the headless terminal (default: 30)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cols</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s1">&#39;number of columns for the headless terminal (default: 60)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">no_exit</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="s2">&quot;whether to keep ht running even after the underlying command exits</span><span class="se">\n</span><span class="s2">allows the caller to take snapshots even after the command has completed</span><span class="se">\n</span><span class="s2">requires the caller to send an explicit &#39;exit&#39; event to cause ht to exit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">logger</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">],</span> <span class="s1">&#39;callers can override the default logger with their own&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">extra_subscribes</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">htty_core</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">HtEvent</span><span class="p">]],</span> <span class="s1">&#39;additional event types to subscribe to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#HtWrapper">HtWrapper</a></span>:</span></span>

                <label class="view-source-button" for="run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run-642"><a href="#run-642"><span class="linenos">642</span></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
</span><span id="run-643"><a href="#run-643"><span class="linenos">643</span></a>    <span class="n">command</span><span class="p">:</span> <span class="n">Command</span><span class="p">,</span>
</span><span id="run-644"><a href="#run-644"><span class="linenos">644</span></a>    <span class="n">rows</span><span class="p">:</span> <span class="n">Rows</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="run-645"><a href="#run-645"><span class="linenos">645</span></a>    <span class="n">cols</span><span class="p">:</span> <span class="n">Cols</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="run-646"><a href="#run-646"><span class="linenos">646</span></a>    <span class="n">no_exit</span><span class="p">:</span> <span class="n">NoExit</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="run-647"><a href="#run-647"><span class="linenos">647</span></a>    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="run-648"><a href="#run-648"><span class="linenos">648</span></a>    <span class="n">extra_subscribes</span><span class="p">:</span> <span class="n">ExtraSubscribes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="run-649"><a href="#run-649"><span class="linenos">649</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HtWrapper</span><span class="p">:</span>
</span><span id="run-650"><a href="#run-650"><span class="linenos">650</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="run-651"><a href="#run-651"><span class="linenos">651</span></a><span class="sd">    As a user of the htty python library, your code will run in the python process at the root of this</span>
</span><span id="run-652"><a href="#run-652"><span class="linenos">652</span></a><span class="sd">    process tree:</span>
</span><span id="run-653"><a href="#run-653"><span class="linenos">653</span></a>
</span><span id="run-654"><a href="#run-654"><span class="linenos">654</span></a><span class="sd">        python &#39;{/path/to/your/code.py}&#39;</span>
</span><span id="run-655"><a href="#run-655"><span class="linenos">655</span></a><span class="sd">        └── ht</span>
</span><span id="run-656"><a href="#run-656"><span class="linenos">656</span></a><span class="sd">            └── sh -c &#39;{modified command}&#39;</span>
</span><span id="run-657"><a href="#run-657"><span class="linenos">657</span></a>
</span><span id="run-658"><a href="#run-658"><span class="linenos">658</span></a><span class="sd">    So if you&#39;re using htty to wrap vim, the process tree is:</span>
</span><span id="run-659"><a href="#run-659"><span class="linenos">659</span></a>
</span><span id="run-660"><a href="#run-660"><span class="linenos">660</span></a><span class="sd">    ```</span>
</span><span id="run-661"><a href="#run-661"><span class="linenos">661</span></a><span class="sd">    python</span>
</span><span id="run-662"><a href="#run-662"><span class="linenos">662</span></a><span class="sd">    └── ht</span>
</span><span id="run-663"><a href="#run-663"><span class="linenos">663</span></a><span class="sd">        └── sh</span>
</span><span id="run-664"><a href="#run-664"><span class="linenos">664</span></a><span class="sd">            └── vim</span>
</span><span id="run-665"><a href="#run-665"><span class="linenos">665</span></a><span class="sd">    ```</span>
</span><span id="run-666"><a href="#run-666"><span class="linenos">666</span></a>
</span><span id="run-667"><a href="#run-667"><span class="linenos">667</span></a><span class="sd">    This function invokes `ht` as a subprocess such that you end up with a process tree like the one shown</span>
</span><span id="run-668"><a href="#run-668"><span class="linenos">668</span></a><span class="sd">    above. It returns an `HtWrapper` object which can be used to interact with ht and its child process.</span>
</span><span id="run-669"><a href="#run-669"><span class="linenos">669</span></a>
</span><span id="run-670"><a href="#run-670"><span class="linenos">670</span></a><span class="sd">    It&#39;s up to you to clean up this process when you&#39;re done:</span>
</span><span id="run-671"><a href="#run-671"><span class="linenos">671</span></a>
</span><span id="run-672"><a href="#run-672"><span class="linenos">672</span></a><span class="sd">    ```python</span>
</span><span id="run-673"><a href="#run-673"><span class="linenos">673</span></a><span class="sd">    proc = run(&quot;some command&quot;)</span>
</span><span id="run-674"><a href="#run-674"><span class="linenos">674</span></a><span class="sd">    # do stuff</span>
</span><span id="run-675"><a href="#run-675"><span class="linenos">675</span></a><span class="sd">    proc.exit()</span>
</span><span id="run-676"><a href="#run-676"><span class="linenos">676</span></a><span class="sd">    ```</span>
</span><span id="run-677"><a href="#run-677"><span class="linenos">677</span></a>
</span><span id="run-678"><a href="#run-678"><span class="linenos">678</span></a><span class="sd">    If you&#39;d rather not risk having a bunch of `ht` processes lying around and wasting CPU cycles,</span>
</span><span id="run-679"><a href="#run-679"><span class="linenos">679</span></a><span class="sd">    consider using the `terminal_session` instead.</span>
</span><span id="run-680"><a href="#run-680"><span class="linenos">680</span></a>
</span><span id="run-681"><a href="#run-681"><span class="linenos">681</span></a><span class="sd">    For reasons that are documented in</span>
</span><span id="run-682"><a href="#run-682"><span class="linenos">682</span></a><span class="sd">    [htty-core](https://matrixmanatyrservice.github.io/htty/htty-core/htty_core.html#HtEvent.COMMAND_COMPLETED), the</span>
</span><span id="run-683"><a href="#run-683"><span class="linenos">683</span></a><span class="sd">    command that ht runs is not:</span>
</span><span id="run-684"><a href="#run-684"><span class="linenos">684</span></a>
</span><span id="run-685"><a href="#run-685"><span class="linenos">685</span></a><span class="sd">        sh -c &#39;{command}&#39;</span>
</span><span id="run-686"><a href="#run-686"><span class="linenos">686</span></a>
</span><span id="run-687"><a href="#run-687"><span class="linenos">687</span></a><span class="sd">    Instead it&#39;s something like this:</span>
</span><span id="run-688"><a href="#run-688"><span class="linenos">688</span></a>
</span><span id="run-689"><a href="#run-689"><span class="linenos">689</span></a><span class="sd">        sh -c &#39;{command} ; exit_code=$? ; /path/to/ht wait-exit /path/to/tmp/ht_fifo_5432 ; exit $exit_code&#39;</span>
</span><span id="run-690"><a href="#run-690"><span class="linenos">690</span></a>
</span><span id="run-691"><a href="#run-691"><span class="linenos">691</span></a><span class="sd">    Because of this, it&#39;s possible to come up with command strings that cause sh to behave in problematic ways (for</span>
</span><span id="run-692"><a href="#run-692"><span class="linenos">692</span></a><span class="sd">    example: `&#39;`). For now the mitigation for this is: &quot;don&#39;t do that.&quot; (If you&#39;d like me to prioritize changing this</span>
</span><span id="run-693"><a href="#run-693"><span class="linenos">693</span></a><span class="sd">    please leave a comment in https://github.com/MatrixManAtYrService/htty/issues/2)</span>
</span><span id="run-694"><a href="#run-694"><span class="linenos">694</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="run-695"><a href="#run-695"><span class="linenos">695</span></a>    <span class="c1"># Use provided logger or fall back to default</span>
</span><span id="run-696"><a href="#run-696"><span class="linenos">696</span></a>    <span class="n">process_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">default_logger</span>
</span><span id="run-697"><a href="#run-697"><span class="linenos">697</span></a>
</span><span id="run-698"><a href="#run-698"><span class="linenos">698</span></a>    <span class="c1"># Create a queue for events</span>
</span><span id="run-699"><a href="#run-699"><span class="linenos">699</span></a>    <span class="n">event_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="run-700"><a href="#run-700"><span class="linenos">700</span></a>
</span><span id="run-701"><a href="#run-701"><span class="linenos">701</span></a>    <span class="c1"># Build the ht subscription list</span>
</span><span id="run-702"><a href="#run-702"><span class="linenos">702</span></a>    <span class="n">base_subscribes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="run-703"><a href="#run-703"><span class="linenos">703</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span>
</span><span id="run-704"><a href="#run-704"><span class="linenos">704</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">,</span>
</span><span id="run-705"><a href="#run-705"><span class="linenos">705</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">,</span>
</span><span id="run-706"><a href="#run-706"><span class="linenos">706</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">RESIZE</span><span class="p">,</span>
</span><span id="run-707"><a href="#run-707"><span class="linenos">707</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">PID</span><span class="p">,</span>
</span><span id="run-708"><a href="#run-708"><span class="linenos">708</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">EXIT_CODE</span><span class="p">,</span>
</span><span id="run-709"><a href="#run-709"><span class="linenos">709</span></a>        <span class="n">HtEvent</span><span class="o">.</span><span class="n">COMMAND_COMPLETED</span><span class="p">,</span>
</span><span id="run-710"><a href="#run-710"><span class="linenos">710</span></a>    <span class="p">]</span>
</span><span id="run-711"><a href="#run-711"><span class="linenos">711</span></a>    <span class="k">if</span> <span class="n">extra_subscribes</span><span class="p">:</span>
</span><span id="run-712"><a href="#run-712"><span class="linenos">712</span></a>        <span class="c1"># Convert string subscribes to HtEvent enum values</span>
</span><span id="run-713"><a href="#run-713"><span class="linenos">713</span></a>        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">extra_subscribes</span><span class="p">:</span>
</span><span id="run-714"><a href="#run-714"><span class="linenos">714</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="run-715"><a href="#run-715"><span class="linenos">715</span></a>                <span class="n">base_subscribes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HtEvent</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
</span><span id="run-716"><a href="#run-716"><span class="linenos">716</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="run-717"><a href="#run-717"><span class="linenos">717</span></a>                <span class="n">process_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown subscription event: </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-718"><a href="#run-718"><span class="linenos">718</span></a>
</span><span id="run-719"><a href="#run-719"><span class="linenos">719</span></a>    <span class="c1"># Convert command to string if it&#39;s a list, properly escaping shell arguments</span>
</span><span id="run-720"><a href="#run-720"><span class="linenos">720</span></a>    <span class="n">command_str</span> <span class="o">=</span> <span class="n">command</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">command</span><span class="p">)</span>
</span><span id="run-721"><a href="#run-721"><span class="linenos">721</span></a>
</span><span id="run-722"><a href="#run-722"><span class="linenos">722</span></a>    <span class="c1"># Create HtArgs and use htty_core.run()</span>
</span><span id="run-723"><a href="#run-723"><span class="linenos">723</span></a>    <span class="n">ht_args</span> <span class="o">=</span> <span class="n">HtArgs</span><span class="p">(</span>
</span><span id="run-724"><a href="#run-724"><span class="linenos">724</span></a>        <span class="n">command</span><span class="o">=</span><span class="n">command_str</span><span class="p">,</span>  <span class="c1"># Use the already-formatted command string</span>
</span><span id="run-725"><a href="#run-725"><span class="linenos">725</span></a>        <span class="n">subscribes</span><span class="o">=</span><span class="n">base_subscribes</span><span class="p">,</span>
</span><span id="run-726"><a href="#run-726"><span class="linenos">726</span></a>        <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
</span><span id="run-727"><a href="#run-727"><span class="linenos">727</span></a>        <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span>
</span><span id="run-728"><a href="#run-728"><span class="linenos">728</span></a>    <span class="p">)</span>
</span><span id="run-729"><a href="#run-729"><span class="linenos">729</span></a>
</span><span id="run-730"><a href="#run-730"><span class="linenos">730</span></a>    <span class="c1"># Log the exact command that would be run</span>
</span><span id="run-731"><a href="#run-731"><span class="linenos">731</span></a>    <span class="n">cmd_args</span> <span class="o">=</span> <span class="n">ht_args</span><span class="o">.</span><span class="n">get_command</span><span class="p">()</span>
</span><span id="run-732"><a href="#run-732"><span class="linenos">732</span></a>    <span class="n">process_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Launching command: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-733"><a href="#run-733"><span class="linenos">733</span></a>
</span><span id="run-734"><a href="#run-734"><span class="linenos">734</span></a>    <span class="n">ht_proc</span> <span class="o">=</span> <span class="n">htty_core_run</span><span class="p">(</span><span class="n">ht_args</span><span class="p">)</span>
</span><span id="run-735"><a href="#run-735"><span class="linenos">735</span></a>
</span><span id="run-736"><a href="#run-736"><span class="linenos">736</span></a>    <span class="n">process_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht started: PID </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-737"><a href="#run-737"><span class="linenos">737</span></a>
</span><span id="run-738"><a href="#run-738"><span class="linenos">738</span></a>    <span class="c1"># Create a reader thread to capture ht output</span>
</span><span id="run-739"><a href="#run-739"><span class="linenos">739</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reader_thread</span><span class="p">(</span>
</span><span id="run-740"><a href="#run-740"><span class="linenos">740</span></a>        <span class="n">ht_proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="run-741"><a href="#run-741"><span class="linenos">741</span></a>        <span class="n">queue_obj</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="run-742"><a href="#run-742"><span class="linenos">742</span></a>        <span class="n">ht_process</span><span class="p">:</span> <span class="n">HtWrapper</span><span class="p">,</span>
</span><span id="run-743"><a href="#run-743"><span class="linenos">743</span></a>        <span class="n">thread_logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
</span><span id="run-744"><a href="#run-744"><span class="linenos">744</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-745"><a href="#run-745"><span class="linenos">745</span></a>        <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reader thread started for ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-746"><a href="#run-746"><span class="linenos">746</span></a>
</span><span id="run-747"><a href="#run-747"><span class="linenos">747</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="run-748"><a href="#run-748"><span class="linenos">748</span></a>            <span class="k">if</span> <span class="n">ht_proc</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-749"><a href="#run-749"><span class="linenos">749</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> stdout is None, exiting reader thread&quot;</span><span class="p">)</span>
</span><span id="run-750"><a href="#run-750"><span class="linenos">750</span></a>                <span class="k">break</span>
</span><span id="run-751"><a href="#run-751"><span class="linenos">751</span></a>
</span><span id="run-752"><a href="#run-752"><span class="linenos">752</span></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">ht_proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span><span id="run-753"><a href="#run-753"><span class="linenos">753</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span><span id="run-754"><a href="#run-754"><span class="linenos">754</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> stdout closed, exiting reader thread&quot;</span><span class="p">)</span>
</span><span id="run-755"><a href="#run-755"><span class="linenos">755</span></a>                <span class="k">break</span>
</span><span id="run-756"><a href="#run-756"><span class="linenos">756</span></a>
</span><span id="run-757"><a href="#run-757"><span class="linenos">757</span></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="run-758"><a href="#run-758"><span class="linenos">758</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span><span id="run-759"><a href="#run-759"><span class="linenos">759</span></a>                <span class="k">continue</span>
</span><span id="run-760"><a href="#run-760"><span class="linenos">760</span></a>
</span><span id="run-761"><a href="#run-761"><span class="linenos">761</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="run-762"><a href="#run-762"><span class="linenos">762</span></a>                <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="run-763"><a href="#run-763"><span class="linenos">763</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht event: </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-764"><a href="#run-764"><span class="linenos">764</span></a>                <span class="n">queue_obj</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="run-765"><a href="#run-765"><span class="linenos">765</span></a>
</span><span id="run-766"><a href="#run-766"><span class="linenos">766</span></a>                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
</span><span id="run-767"><a href="#run-767"><span class="linenos">767</span></a>                    <span class="n">ht_process</span><span class="o">.</span><span class="n">add_output_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="run-768"><a href="#run-768"><span class="linenos">768</span></a>                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;exitCode&quot;</span><span class="p">:</span>
</span><span id="run-769"><a href="#run-769"><span class="linenos">769</span></a>                    <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="run-770"><a href="#run-770"><span class="linenos">770</span></a>                        <span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> subprocess exited with code: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exitCode&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="run-771"><a href="#run-771"><span class="linenos">771</span></a>                    <span class="p">)</span>
</span><span id="run-772"><a href="#run-772"><span class="linenos">772</span></a>                    <span class="n">ht_process</span><span class="o">.</span><span class="n">set_subprocess_exited</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="run-773"><a href="#run-773"><span class="linenos">773</span></a>                    <span class="n">exit_code</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exitCode&quot;</span><span class="p">)</span>
</span><span id="run-774"><a href="#run-774"><span class="linenos">774</span></a>                    <span class="k">if</span> <span class="n">exit_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-775"><a href="#run-775"><span class="linenos">775</span></a>                        <span class="n">ht_process</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">exit_code</span>
</span><span id="run-776"><a href="#run-776"><span class="linenos">776</span></a>                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span>
</span><span id="run-777"><a href="#run-777"><span class="linenos">777</span></a>                    <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> subprocess PID: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-778"><a href="#run-778"><span class="linenos">778</span></a>                    <span class="n">pid</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span>
</span><span id="run-779"><a href="#run-779"><span class="linenos">779</span></a>                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-780"><a href="#run-780"><span class="linenos">780</span></a>                        <span class="n">ht_process</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
</span><span id="run-781"><a href="#run-781"><span class="linenos">781</span></a>                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;commandCompleted&quot;</span><span class="p">:</span>
</span><span id="run-782"><a href="#run-782"><span class="linenos">782</span></a>                    <span class="c1"># Command has completed - this is the reliable signal that subprocess finished</span>
</span><span id="run-783"><a href="#run-783"><span class="linenos">783</span></a>                    <span class="n">ht_process</span><span class="o">.</span><span class="n">set_subprocess_completed</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="run-784"><a href="#run-784"><span class="linenos">784</span></a>                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
</span><span id="run-785"><a href="#run-785"><span class="linenos">785</span></a>                    <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> debug: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-786"><a href="#run-786"><span class="linenos">786</span></a>                    <span class="c1"># Note: We no longer rely on debug events for subprocess_completed</span>
</span><span id="run-787"><a href="#run-787"><span class="linenos">787</span></a>                    <span class="c1"># The commandCompleted event (above) is the reliable source</span>
</span><span id="run-788"><a href="#run-788"><span class="linenos">788</span></a>            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="run-789"><a href="#run-789"><span class="linenos">789</span></a>                <span class="c1"># Only log raw stdout when we can&#39;t parse it as JSON - this indicates an unexpected message</span>
</span><span id="run-790"><a href="#run-790"><span class="linenos">790</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> non-JSON stdout: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2"> (error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="run-791"><a href="#run-791"><span class="linenos">791</span></a>                <span class="k">pass</span>
</span><span id="run-792"><a href="#run-792"><span class="linenos">792</span></a>
</span><span id="run-793"><a href="#run-793"><span class="linenos">793</span></a>        <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reader thread exiting for ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-794"><a href="#run-794"><span class="linenos">794</span></a>
</span><span id="run-795"><a href="#run-795"><span class="linenos">795</span></a>    <span class="c1"># Create an HtWrapper instance</span>
</span><span id="run-796"><a href="#run-796"><span class="linenos">796</span></a>    <span class="n">process</span> <span class="o">=</span> <span class="n">HtWrapper</span><span class="p">(</span>
</span><span id="run-797"><a href="#run-797"><span class="linenos">797</span></a>        <span class="n">ht_proc</span><span class="p">,</span>
</span><span id="run-798"><a href="#run-798"><span class="linenos">798</span></a>        <span class="n">event_queue</span><span class="p">,</span>
</span><span id="run-799"><a href="#run-799"><span class="linenos">799</span></a>        <span class="n">command</span><span class="o">=</span><span class="n">command_str</span><span class="p">,</span>
</span><span id="run-800"><a href="#run-800"><span class="linenos">800</span></a>        <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
</span><span id="run-801"><a href="#run-801"><span class="linenos">801</span></a>        <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span>
</span><span id="run-802"><a href="#run-802"><span class="linenos">802</span></a>        <span class="n">no_exit</span><span class="o">=</span><span class="n">no_exit</span><span class="p">,</span>
</span><span id="run-803"><a href="#run-803"><span class="linenos">803</span></a>        <span class="n">logger</span><span class="o">=</span><span class="n">process_logger</span><span class="p">,</span>
</span><span id="run-804"><a href="#run-804"><span class="linenos">804</span></a>    <span class="p">)</span>
</span><span id="run-805"><a href="#run-805"><span class="linenos">805</span></a>
</span><span id="run-806"><a href="#run-806"><span class="linenos">806</span></a>    <span class="c1"># Start the reader thread for stdout</span>
</span><span id="run-807"><a href="#run-807"><span class="linenos">807</span></a>    <span class="n">stdout_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
</span><span id="run-808"><a href="#run-808"><span class="linenos">808</span></a>        <span class="n">target</span><span class="o">=</span><span class="n">reader_thread</span><span class="p">,</span>
</span><span id="run-809"><a href="#run-809"><span class="linenos">809</span></a>        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ht_proc</span><span class="p">,</span> <span class="n">event_queue</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">process_logger</span><span class="p">),</span>
</span><span id="run-810"><a href="#run-810"><span class="linenos">810</span></a>        <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="run-811"><a href="#run-811"><span class="linenos">811</span></a>    <span class="p">)</span>
</span><span id="run-812"><a href="#run-812"><span class="linenos">812</span></a>    <span class="n">stdout_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="run-813"><a href="#run-813"><span class="linenos">813</span></a>
</span><span id="run-814"><a href="#run-814"><span class="linenos">814</span></a>    <span class="c1"># Start a stderr reader thread</span>
</span><span id="run-815"><a href="#run-815"><span class="linenos">815</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stderr_reader_thread</span><span class="p">(</span><span class="n">ht_proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">thread_logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-816"><a href="#run-816"><span class="linenos">816</span></a>        <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stderr reader thread started for ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-817"><a href="#run-817"><span class="linenos">817</span></a>
</span><span id="run-818"><a href="#run-818"><span class="linenos">818</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="run-819"><a href="#run-819"><span class="linenos">819</span></a>            <span class="k">if</span> <span class="n">ht_proc</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-820"><a href="#run-820"><span class="linenos">820</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> stderr is None, exiting stderr reader thread&quot;</span><span class="p">)</span>
</span><span id="run-821"><a href="#run-821"><span class="linenos">821</span></a>                <span class="k">break</span>
</span><span id="run-822"><a href="#run-822"><span class="linenos">822</span></a>
</span><span id="run-823"><a href="#run-823"><span class="linenos">823</span></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">ht_proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span><span id="run-824"><a href="#run-824"><span class="linenos">824</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span><span id="run-825"><a href="#run-825"><span class="linenos">825</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> stderr closed, exiting stderr reader thread&quot;</span><span class="p">)</span>
</span><span id="run-826"><a href="#run-826"><span class="linenos">826</span></a>                <span class="k">break</span>
</span><span id="run-827"><a href="#run-827"><span class="linenos">827</span></a>
</span><span id="run-828"><a href="#run-828"><span class="linenos">828</span></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="run-829"><a href="#run-829"><span class="linenos">829</span></a>            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span><span id="run-830"><a href="#run-830"><span class="linenos">830</span></a>                <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht stderr: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-831"><a href="#run-831"><span class="linenos">831</span></a>
</span><span id="run-832"><a href="#run-832"><span class="linenos">832</span></a>        <span class="n">thread_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stderr reader thread exiting for ht process </span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run-833"><a href="#run-833"><span class="linenos">833</span></a>
</span><span id="run-834"><a href="#run-834"><span class="linenos">834</span></a>    <span class="n">stderr_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stderr_reader_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ht_proc</span><span class="p">,</span> <span class="n">process_logger</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="run-835"><a href="#run-835"><span class="linenos">835</span></a>    <span class="n">stderr_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="run-836"><a href="#run-836"><span class="linenos">836</span></a>
</span><span id="run-837"><a href="#run-837"><span class="linenos">837</span></a>    <span class="c1"># Wait briefly for the process to initialize and get PID</span>
</span><span id="run-838"><a href="#run-838"><span class="linenos">838</span></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="run-839"><a href="#run-839"><span class="linenos">839</span></a>    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="run-840"><a href="#run-840"><span class="linenos">840</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="run-841"><a href="#run-841"><span class="linenos">841</span></a>            <span class="n">event</span> <span class="o">=</span> <span class="n">event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="run-842"><a href="#run-842"><span class="linenos">842</span></a>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span>
</span><span id="run-843"><a href="#run-843"><span class="linenos">843</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span>
</span><span id="run-844"><a href="#run-844"><span class="linenos">844</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
</span><span id="run-845"><a href="#run-845"><span class="linenos">845</span></a>                <span class="k">break</span>
</span><span id="run-846"><a href="#run-846"><span class="linenos">846</span></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="run-847"><a href="#run-847"><span class="linenos">847</span></a>            <span class="k">continue</span>
</span><span id="run-848"><a href="#run-848"><span class="linenos">848</span></a>
</span><span id="run-849"><a href="#run-849"><span class="linenos">849</span></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="run-850"><a href="#run-850"><span class="linenos">850</span></a>    <span class="k">return</span> <span class="n">process</span>
</span></pre></div>


            <div class="docstring"><p>As a user of the htty python library, your code will run in the python process at the root of this
process tree:</p>

<pre><code>python '{/path/to/your/code.py}'
└── ht
    └── sh -c '{modified command}'
</code></pre>

<p>So if you're using htty to wrap vim, the process tree is:</p>

<pre><code>python
└── ht
    └── sh
        └── vim
</code></pre>

<p>This function invokes <code>ht</code> as a subprocess such that you end up with a process tree like the one shown
above. It returns an <code><a href="#HtWrapper">HtWrapper</a></code> object which can be used to interact with ht and its child process.</p>

<p>It's up to you to clean up this process when you're done:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">proc</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;some command&quot;</span><span class="p">)</span>
<span class="c1"># do stuff</span>
<span class="n">proc</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</code></pre>
</div>

<p>If you'd rather not risk having a bunch of <code>ht</code> processes lying around and wasting CPU cycles,
consider using the <code><a href="#terminal_session">terminal_session</a></code> instead.</p>

<p>For reasons that are documented in
<a href="https://matrixmanatyrservice.github.io/htty/htty-core/htty_core.html#HtEvent.COMMAND_COMPLETED">htty-core</a>, the
command that ht runs is not:</p>

<pre><code>sh -c '{command}'
</code></pre>

<p>Instead it's something like this:</p>

<pre><code>sh -c '{command} ; exit_code=$? ; /path/to/ht wait-exit /path/to/tmp/ht_fifo_5432 ; exit $exit_code'
</code></pre>

<p>Because of this, it's possible to come up with command strings that cause sh to behave in problematic ways (for
example: <code>'</code>). For now the mitigation for this is: "don't do that." (If you'd like me to prioritize changing this
please leave a comment in <a href="https://github.com/MatrixManAtYrService/htty/issues/2">https://github.com/MatrixManAtYrService/htty/issues/2</a>)</p>
</div>


                </section>
                <section id="HtWrapper">
                            <input id="HtWrapper-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HtWrapper</span>:

                <label class="view-source-button" for="HtWrapper-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper-80"><a href="#HtWrapper-80"><span class="linenos"> 80</span></a><span class="k">class</span><span class="w"> </span><span class="nc">HtWrapper</span><span class="p">:</span>
</span><span id="HtWrapper-81"><a href="#HtWrapper-81"><span class="linenos"> 81</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-82"><a href="#HtWrapper-82"><span class="linenos"> 82</span></a><span class="sd">    A wrapper around a process started with the &#39;ht&#39; tool that provides</span>
</span><span id="HtWrapper-83"><a href="#HtWrapper-83"><span class="linenos"> 83</span></a><span class="sd">    methods for interacting with the process and capturing its output.</span>
</span><span id="HtWrapper-84"><a href="#HtWrapper-84"><span class="linenos"> 84</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HtWrapper-85"><a href="#HtWrapper-85"><span class="linenos"> 85</span></a>
</span><span id="HtWrapper-86"><a href="#HtWrapper-86"><span class="linenos"> 86</span></a>    <span class="n">ht</span><span class="p">:</span> <span class="n">ProcessController</span>
</span><span id="HtWrapper-87"><a href="#HtWrapper-87"><span class="linenos"> 87</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-88"><a href="#HtWrapper-88"><span class="linenos"> 88</span></a><span class="sd">    Helpers for interacting with the `ht` process (a child process of the python</span>
</span><span id="HtWrapper-89"><a href="#HtWrapper-89"><span class="linenos"> 89</span></a><span class="sd">    that called `htty.run` or `htty.terminal_session`)</span>
</span><span id="HtWrapper-90"><a href="#HtWrapper-90"><span class="linenos"> 90</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HtWrapper-91"><a href="#HtWrapper-91"><span class="linenos"> 91</span></a>
</span><span id="HtWrapper-92"><a href="#HtWrapper-92"><span class="linenos"> 92</span></a>    <span class="n">cmd</span><span class="p">:</span> <span class="n">ProcessController</span>
</span><span id="HtWrapper-93"><a href="#HtWrapper-93"><span class="linenos"> 93</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-94"><a href="#HtWrapper-94"><span class="linenos"> 94</span></a><span class="sd">    Helpers for interacting with the shell that wraps the caller&#39;s command (`ht`&#39;s child process)</span>
</span><span id="HtWrapper-95"><a href="#HtWrapper-95"><span class="linenos"> 95</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HtWrapper-96"><a href="#HtWrapper-96"><span class="linenos"> 96</span></a>
</span><span id="HtWrapper-97"><a href="#HtWrapper-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HtWrapper-98"><a href="#HtWrapper-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HtWrapper-99"><a href="#HtWrapper-99"><span class="linenos"> 99</span></a>        <span class="n">ht_proc</span><span class="p">:</span> <span class="s2">&quot;subprocess.Popen[str]&quot;</span><span class="p">,</span>
</span><span id="HtWrapper-100"><a href="#HtWrapper-100"><span class="linenos">100</span></a>        <span class="n">event_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="HtWrapper-101"><a href="#HtWrapper-101"><span class="linenos">101</span></a>        <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HtWrapper-102"><a href="#HtWrapper-102"><span class="linenos">102</span></a>        <span class="n">pid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HtWrapper-103"><a href="#HtWrapper-103"><span class="linenos">103</span></a>        <span class="n">rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HtWrapper-104"><a href="#HtWrapper-104"><span class="linenos">104</span></a>        <span class="n">cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HtWrapper-105"><a href="#HtWrapper-105"><span class="linenos">105</span></a>        <span class="n">no_exit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="HtWrapper-106"><a href="#HtWrapper-106"><span class="linenos">106</span></a>        <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HtWrapper-107"><a href="#HtWrapper-107"><span class="linenos">107</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-108"><a href="#HtWrapper-108"><span class="linenos">108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-109"><a href="#HtWrapper-109"><span class="linenos">109</span></a><span class="sd">        @private</span>
</span><span id="HtWrapper-110"><a href="#HtWrapper-110"><span class="linenos">110</span></a><span class="sd">        Users are not expect to create these directly.</span>
</span><span id="HtWrapper-111"><a href="#HtWrapper-111"><span class="linenos">111</span></a><span class="sd">        They should use `with terminal_session(...)` or `run(...)`</span>
</span><span id="HtWrapper-112"><a href="#HtWrapper-112"><span class="linenos">112</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-113"><a href="#HtWrapper-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span> <span class="o">=</span> <span class="n">ht_proc</span>  <span class="c1"># The ht process itself</span>
</span><span id="HtWrapper-114"><a href="#HtWrapper-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span> <span class="o">=</span> <span class="n">CmdProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span><span id="HtWrapper-115"><a href="#HtWrapper-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span> <span class="o">=</span> <span class="n">event_queue</span>
</span><span id="HtWrapper-116"><a href="#HtWrapper-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">command</span>
</span><span id="HtWrapper-117"><a href="#HtWrapper-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="HtWrapper-118"><a href="#HtWrapper-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_unknown_events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="HtWrapper-119"><a href="#HtWrapper-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="HtWrapper-120"><a href="#HtWrapper-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-121"><a href="#HtWrapper-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="HtWrapper-122"><a href="#HtWrapper-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span> <span class="o">=</span> <span class="n">rows</span>
</span><span id="HtWrapper-123"><a href="#HtWrapper-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cols</span> <span class="o">=</span> <span class="n">cols</span>
</span><span id="HtWrapper-124"><a href="#HtWrapper-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_no_exit</span> <span class="o">=</span> <span class="n">no_exit</span>
</span><span id="HtWrapper-125"><a href="#HtWrapper-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="HtWrapper-126"><a href="#HtWrapper-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_completed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Set earlier when command completion is detected</span>
</span><span id="HtWrapper-127"><a href="#HtWrapper-127"><span class="linenos">127</span></a>
</span><span id="HtWrapper-128"><a href="#HtWrapper-128"><span class="linenos">128</span></a>        <span class="c1"># Use provided logger or fall back to default</span>
</span><span id="HtWrapper-129"><a href="#HtWrapper-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">default_logger</span>
</span><span id="HtWrapper-130"><a href="#HtWrapper-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTProcess created: ht_proc.pid=</span><span class="si">{</span><span class="n">ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">, command=</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-131"><a href="#HtWrapper-131"><span class="linenos">131</span></a>
</span><span id="HtWrapper-132"><a href="#HtWrapper-132"><span class="linenos">132</span></a>        <span class="c1"># Create the public interface objects</span>
</span><span id="HtWrapper-133"><a href="#HtWrapper-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ht</span><span class="p">:</span> <span class="n">ProcessController</span> <span class="o">=</span> <span class="n">HtProcess</span><span class="p">(</span><span class="n">ht_proc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="HtWrapper-134"><a href="#HtWrapper-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">:</span> <span class="n">ProcessController</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span>
</span><span id="HtWrapper-135"><a href="#HtWrapper-135"><span class="linenos">135</span></a>
</span><span id="HtWrapper-136"><a href="#HtWrapper-136"><span class="linenos">136</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="HtWrapper-137"><a href="#HtWrapper-137"><span class="linenos">137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor to warn about uncleaned processes.&quot;&quot;&quot;</span>
</span><span id="HtWrapper-138"><a href="#HtWrapper-138"><span class="linenos">138</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ht_proc&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-139"><a href="#HtWrapper-139"><span class="linenos">139</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="HtWrapper-140"><a href="#HtWrapper-140"><span class="linenos">140</span></a>                <span class="sa">f</span><span class="s2">&quot;HTProcess being garbage collected with running ht process (PID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">). &quot;</span>
</span><span id="HtWrapper-141"><a href="#HtWrapper-141"><span class="linenos">141</span></a>                <span class="sa">f</span><span class="s2">&quot;This may cause resource leaks!&quot;</span>
</span><span id="HtWrapper-142"><a href="#HtWrapper-142"><span class="linenos">142</span></a>            <span class="p">)</span>
</span><span id="HtWrapper-143"><a href="#HtWrapper-143"><span class="linenos">143</span></a>            <span class="c1"># Try emergency cleanup</span>
</span><span id="HtWrapper-144"><a href="#HtWrapper-144"><span class="linenos">144</span></a>            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="HtWrapper-145"><a href="#HtWrapper-145"><span class="linenos">145</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="HtWrapper-146"><a href="#HtWrapper-146"><span class="linenos">146</span></a>
</span><span id="HtWrapper-147"><a href="#HtWrapper-147"><span class="linenos">147</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="HtWrapper-148"><a href="#HtWrapper-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-149"><a href="#HtWrapper-149"><span class="linenos">149</span></a><span class="sd">        Return list of [output](./htty-core/htty_core.html#HtEvent.OUTPUT) events.&quot;&quot;&quot;</span>
</span><span id="HtWrapper-150"><a href="#HtWrapper-150"><span class="linenos">150</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">event</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">]</span>
</span><span id="HtWrapper-151"><a href="#HtWrapper-151"><span class="linenos">151</span></a>
</span><span id="HtWrapper-152"><a href="#HtWrapper-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_output_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-153"><a href="#HtWrapper-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-154"><a href="#HtWrapper-154"><span class="linenos">154</span></a><span class="sd">        @private</span>
</span><span id="HtWrapper-155"><a href="#HtWrapper-155"><span class="linenos">155</span></a><span class="sd">        Add an output event (for internal use by reader thread).</span>
</span><span id="HtWrapper-156"><a href="#HtWrapper-156"><span class="linenos">156</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-157"><a href="#HtWrapper-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-158"><a href="#HtWrapper-158"><span class="linenos">158</span></a>
</span><span id="HtWrapper-159"><a href="#HtWrapper-159"><span class="linenos">159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_subprocess_exited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exited</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-160"><a href="#HtWrapper-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-161"><a href="#HtWrapper-161"><span class="linenos">161</span></a><span class="sd">        @private</span>
</span><span id="HtWrapper-162"><a href="#HtWrapper-162"><span class="linenos">162</span></a><span class="sd">        Set subprocess exited flag (for internal use by reader thread).</span>
</span><span id="HtWrapper-163"><a href="#HtWrapper-163"><span class="linenos">163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-164"><a href="#HtWrapper-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span> <span class="o">=</span> <span class="n">exited</span>
</span><span id="HtWrapper-165"><a href="#HtWrapper-165"><span class="linenos">165</span></a>
</span><span id="HtWrapper-166"><a href="#HtWrapper-166"><span class="linenos">166</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_subprocess_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-167"><a href="#HtWrapper-167"><span class="linenos">167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-168"><a href="#HtWrapper-168"><span class="linenos">168</span></a><span class="sd">        @private</span>
</span><span id="HtWrapper-169"><a href="#HtWrapper-169"><span class="linenos">169</span></a><span class="sd">        Set subprocess completed flag (for internal use by reader thread).</span>
</span><span id="HtWrapper-170"><a href="#HtWrapper-170"><span class="linenos">170</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-171"><a href="#HtWrapper-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_completed</span> <span class="o">=</span> <span class="n">completed</span>
</span><span id="HtWrapper-172"><a href="#HtWrapper-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">set_completed</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
</span><span id="HtWrapper-173"><a href="#HtWrapper-173"><span class="linenos">173</span></a>
</span><span id="HtWrapper-174"><a href="#HtWrapper-174"><span class="linenos">174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">KeyInput</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">KeyInput</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-175"><a href="#HtWrapper-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-176"><a href="#HtWrapper-176"><span class="linenos">176</span></a><span class="sd">        Send keys to the terminal.  Accepts strings, `Press` objects, and lists of strings or `Press` objects.</span>
</span><span id="HtWrapper-177"><a href="#HtWrapper-177"><span class="linenos">177</span></a><span class="sd">        For keys that you can `Press`, see</span>
</span><span id="HtWrapper-178"><a href="#HtWrapper-178"><span class="linenos">178</span></a><span class="sd">        [keys.py](https://github.com/MatrixManAtYrService/htty/blob/main/htty/src/htty/keys.py).</span>
</span><span id="HtWrapper-179"><a href="#HtWrapper-179"><span class="linenos">179</span></a>
</span><span id="HtWrapper-180"><a href="#HtWrapper-180"><span class="linenos">180</span></a><span class="sd">        ```python</span>
</span><span id="HtWrapper-181"><a href="#HtWrapper-181"><span class="linenos">181</span></a><span class="sd">        from htty import Press, terminal_session</span>
</span><span id="HtWrapper-182"><a href="#HtWrapper-182"><span class="linenos">182</span></a>
</span><span id="HtWrapper-183"><a href="#HtWrapper-183"><span class="linenos">183</span></a><span class="sd">        with (</span>
</span><span id="HtWrapper-184"><a href="#HtWrapper-184"><span class="linenos">184</span></a><span class="sd">            terminal_session(&quot;sh -i&quot;, rows=4, cols=40, logger=test_logger) as sh,</span>
</span><span id="HtWrapper-185"><a href="#HtWrapper-185"><span class="linenos">185</span></a><span class="sd">        ):</span>
</span><span id="HtWrapper-186"><a href="#HtWrapper-186"><span class="linenos">186</span></a><span class="sd">            sh.send_keys(&quot;echo foo &amp;&amp; sleep 999&quot;)</span>
</span><span id="HtWrapper-187"><a href="#HtWrapper-187"><span class="linenos">187</span></a><span class="sd">            sh.send_keys(Press.ENTER)</span>
</span><span id="HtWrapper-188"><a href="#HtWrapper-188"><span class="linenos">188</span></a><span class="sd">            sh.expect(&quot;^foo&quot;)</span>
</span><span id="HtWrapper-189"><a href="#HtWrapper-189"><span class="linenos">189</span></a><span class="sd">            sh.send_keys(Press.CTRL_Z)</span>
</span><span id="HtWrapper-190"><a href="#HtWrapper-190"><span class="linenos">190</span></a><span class="sd">            sh.expect(&quot;Stopped&quot;)</span>
</span><span id="HtWrapper-191"><a href="#HtWrapper-191"><span class="linenos">191</span></a><span class="sd">            sh.send_keys([&quot;clear&quot;, Press.ENTER])</span>
</span><span id="HtWrapper-192"><a href="#HtWrapper-192"><span class="linenos">192</span></a><span class="sd">        ```</span>
</span><span id="HtWrapper-193"><a href="#HtWrapper-193"><span class="linenos">193</span></a>
</span><span id="HtWrapper-194"><a href="#HtWrapper-194"><span class="linenos">194</span></a><span class="sd">        These are sent to `ht` as events that look like this</span>
</span><span id="HtWrapper-195"><a href="#HtWrapper-195"><span class="linenos">195</span></a>
</span><span id="HtWrapper-196"><a href="#HtWrapper-196"><span class="linenos">196</span></a><span class="sd">        ```json</span>
</span><span id="HtWrapper-197"><a href="#HtWrapper-197"><span class="linenos">197</span></a><span class="sd">        {&quot;type&quot;: &quot;sendKeys&quot;, &quot;keys&quot;: [&quot;echo foo &amp;&amp; sleep 999&quot;, &quot;Enter&quot;]}</span>
</span><span id="HtWrapper-198"><a href="#HtWrapper-198"><span class="linenos">198</span></a><span class="sd">        ```</span>
</span><span id="HtWrapper-199"><a href="#HtWrapper-199"><span class="linenos">199</span></a>
</span><span id="HtWrapper-200"><a href="#HtWrapper-200"><span class="linenos">200</span></a><span class="sd">        Notice that Press.ENTER is still sent as &quot;Enter&quot; under the hood.</span>
</span><span id="HtWrapper-201"><a href="#HtWrapper-201"><span class="linenos">201</span></a><span class="sd">        `ht` checks to see if it corresponds with a known key and sends it letter-at-a-time if not.</span>
</span><span id="HtWrapper-202"><a href="#HtWrapper-202"><span class="linenos">202</span></a>
</span><span id="HtWrapper-203"><a href="#HtWrapper-203"><span class="linenos">203</span></a><span class="sd">        Because of this, you might run into suprises if you want to type individual characters which happen to spell out</span>
</span><span id="HtWrapper-204"><a href="#HtWrapper-204"><span class="linenos">204</span></a><span class="sd">        a known key such as &quot;Enter&quot; or &quot;Backspace&quot;.</span>
</span><span id="HtWrapper-205"><a href="#HtWrapper-205"><span class="linenos">205</span></a>
</span><span id="HtWrapper-206"><a href="#HtWrapper-206"><span class="linenos">206</span></a><span class="sd">        Work around this by breaking up the key names like so:</span>
</span><span id="HtWrapper-207"><a href="#HtWrapper-207"><span class="linenos">207</span></a>
</span><span id="HtWrapper-208"><a href="#HtWrapper-208"><span class="linenos">208</span></a><span class="sd">        ```python</span>
</span><span id="HtWrapper-209"><a href="#HtWrapper-209"><span class="linenos">209</span></a><span class="sd">        sh.send_keys([&quot;Ente&quot;, &quot;r&quot;])</span>
</span><span id="HtWrapper-210"><a href="#HtWrapper-210"><span class="linenos">210</span></a><span class="sd">        ```</span>
</span><span id="HtWrapper-211"><a href="#HtWrapper-211"><span class="linenos">211</span></a>
</span><span id="HtWrapper-212"><a href="#HtWrapper-212"><span class="linenos">212</span></a><span class="sd">        If this behavior is problematic for you, consider submitting an issue.</span>
</span><span id="HtWrapper-213"><a href="#HtWrapper-213"><span class="linenos">213</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-214"><a href="#HtWrapper-214"><span class="linenos">214</span></a>        <span class="n">key_strings</span> <span class="o">=</span> <span class="n">keys_to_strings</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span id="HtWrapper-215"><a href="#HtWrapper-215"><span class="linenos">215</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sendKeys&quot;</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="n">key_strings</span><span class="p">})</span>
</span><span id="HtWrapper-216"><a href="#HtWrapper-216"><span class="linenos">216</span></a>
</span><span id="HtWrapper-217"><a href="#HtWrapper-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending keys: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-218"><a href="#HtWrapper-218"><span class="linenos">218</span></a>
</span><span id="HtWrapper-219"><a href="#HtWrapper-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-220"><a href="#HtWrapper-220"><span class="linenos">220</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-221"><a href="#HtWrapper-221"><span class="linenos">221</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-222"><a href="#HtWrapper-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="HtWrapper-223"><a href="#HtWrapper-223"><span class="linenos">223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Keys sent successfully&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-224"><a href="#HtWrapper-224"><span class="linenos">224</span></a>            <span class="k">except</span> <span class="p">(</span><span class="ne">BrokenPipeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-225"><a href="#HtWrapper-225"><span class="linenos">225</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send keys: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-226"><a href="#HtWrapper-226"><span class="linenos">226</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process poll result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-227"><a href="#HtWrapper-227"><span class="linenos">227</span></a>                <span class="k">raise</span>
</span><span id="HtWrapper-228"><a href="#HtWrapper-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper-229"><a href="#HtWrapper-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ht process stdin is None&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-230"><a href="#HtWrapper-230"><span class="linenos">230</span></a>
</span><span id="HtWrapper-231"><a href="#HtWrapper-231"><span class="linenos">231</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="HtWrapper-232"><a href="#HtWrapper-232"><span class="linenos">232</span></a>
</span><span id="HtWrapper-233"><a href="#HtWrapper-233"><span class="linenos">233</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_SNAPSHOT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotResult</span><span class="p">:</span>
</span><span id="HtWrapper-234"><a href="#HtWrapper-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-235"><a href="#HtWrapper-235"><span class="linenos">235</span></a><span class="sd">        Take a snapshot of the terminal output.</span>
</span><span id="HtWrapper-236"><a href="#HtWrapper-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-237"><a href="#HtWrapper-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-238"><a href="#HtWrapper-238"><span class="linenos">238</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process has exited with code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-239"><a href="#HtWrapper-239"><span class="linenos">239</span></a>
</span><span id="HtWrapper-240"><a href="#HtWrapper-240"><span class="linenos">240</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;takeSnapshot&quot;</span><span class="p">})</span>
</span><span id="HtWrapper-241"><a href="#HtWrapper-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Taking snapshot: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-242"><a href="#HtWrapper-242"><span class="linenos">242</span></a>
</span><span id="HtWrapper-243"><a href="#HtWrapper-243"><span class="linenos">243</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-244"><a href="#HtWrapper-244"><span class="linenos">244</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-245"><a href="#HtWrapper-245"><span class="linenos">245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-246"><a href="#HtWrapper-246"><span class="linenos">246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="HtWrapper-247"><a href="#HtWrapper-247"><span class="linenos">247</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Snapshot request sent successfully&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-248"><a href="#HtWrapper-248"><span class="linenos">248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper-249"><a href="#HtWrapper-249"><span class="linenos">249</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ht process stdin is not available&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-250"><a href="#HtWrapper-250"><span class="linenos">250</span></a>        <span class="k">except</span> <span class="ne">BrokenPipeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-251"><a href="#HtWrapper-251"><span class="linenos">251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send snapshot request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-252"><a href="#HtWrapper-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process poll result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-253"><a href="#HtWrapper-253"><span class="linenos">253</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="HtWrapper-254"><a href="#HtWrapper-254"><span class="linenos">254</span></a>                <span class="sa">f</span><span class="s2">&quot;Cannot communicate with ht process (broken pipe). &quot;</span>
</span><span id="HtWrapper-255"><a href="#HtWrapper-255"><span class="linenos">255</span></a>                <span class="sa">f</span><span class="s2">&quot;Process may have exited. Poll result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="HtWrapper-256"><a href="#HtWrapper-256"><span class="linenos">256</span></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper-257"><a href="#HtWrapper-257"><span class="linenos">257</span></a>
</span><span id="HtWrapper-258"><a href="#HtWrapper-258"><span class="linenos">258</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="HtWrapper-259"><a href="#HtWrapper-259"><span class="linenos">259</span></a>
</span><span id="HtWrapper-260"><a href="#HtWrapper-260"><span class="linenos">260</span></a>        <span class="c1"># Use tenacity to retry getting the snapshot</span>
</span><span id="HtWrapper-261"><a href="#HtWrapper-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_snapshot</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper-262"><a href="#HtWrapper-262"><span class="linenos">262</span></a>
</span><span id="HtWrapper-263"><a href="#HtWrapper-263"><span class="linenos">263</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotResult</span><span class="p">:</span>
</span><span id="HtWrapper-264"><a href="#HtWrapper-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-265"><a href="#HtWrapper-265"><span class="linenos">265</span></a><span class="sd">        Wait for snapshot response from the event queue with timeout and retries.</span>
</span><span id="HtWrapper-266"><a href="#HtWrapper-266"><span class="linenos">266</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-267"><a href="#HtWrapper-267"><span class="linenos">267</span></a>
</span><span id="HtWrapper-268"><a href="#HtWrapper-268"><span class="linenos">268</span></a>        <span class="nd">@retry</span><span class="p">(</span>
</span><span id="HtWrapper-269"><a href="#HtWrapper-269"><span class="linenos">269</span></a>            <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span id="HtWrapper-270"><a href="#HtWrapper-270"><span class="linenos">270</span></a>            <span class="n">wait</span><span class="o">=</span><span class="n">wait_fixed</span><span class="p">(</span><span class="n">SNAPSHOT_RETRY_TIMEOUT</span><span class="p">),</span>
</span><span id="HtWrapper-271"><a href="#HtWrapper-271"><span class="linenos">271</span></a>            <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">SnapshotNotReady</span><span class="p">),</span>
</span><span id="HtWrapper-272"><a href="#HtWrapper-272"><span class="linenos">272</span></a>        <span class="p">)</span>
</span><span id="HtWrapper-273"><a href="#HtWrapper-273"><span class="linenos">273</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SnapshotResult</span><span class="p">:</span>
</span><span id="HtWrapper-274"><a href="#HtWrapper-274"><span class="linenos">274</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-275"><a href="#HtWrapper-275"><span class="linenos">275</span></a>                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">SNAPSHOT_RETRY_TIMEOUT</span><span class="p">)</span>
</span><span id="HtWrapper-276"><a href="#HtWrapper-276"><span class="linenos">276</span></a>            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-277"><a href="#HtWrapper-277"><span class="linenos">277</span></a>                <span class="k">raise</span> <span class="n">SnapshotNotReady</span><span class="p">(</span><span class="s2">&quot;No events available in queue&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper-278"><a href="#HtWrapper-278"><span class="linenos">278</span></a>
</span><span id="HtWrapper-279"><a href="#HtWrapper-279"><span class="linenos">279</span></a>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-280"><a href="#HtWrapper-280"><span class="linenos">280</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="HtWrapper-281"><a href="#HtWrapper-281"><span class="linenos">281</span></a>                <span class="n">snapshot_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
</span><span id="HtWrapper-282"><a href="#HtWrapper-282"><span class="linenos">282</span></a>                <span class="n">raw_seq</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;seq&quot;</span><span class="p">]</span>
</span><span id="HtWrapper-283"><a href="#HtWrapper-283"><span class="linenos">283</span></a>
</span><span id="HtWrapper-284"><a href="#HtWrapper-284"><span class="linenos">284</span></a>                <span class="c1"># Convert to HTML with ANSI color support</span>
</span><span id="HtWrapper-285"><a href="#HtWrapper-285"><span class="linenos">285</span></a>                <span class="n">html</span> <span class="o">=</span> <span class="n">simple_ansi_to_html</span><span class="p">(</span><span class="n">raw_seq</span><span class="p">)</span>
</span><span id="HtWrapper-286"><a href="#HtWrapper-286"><span class="linenos">286</span></a>
</span><span id="HtWrapper-287"><a href="#HtWrapper-287"><span class="linenos">287</span></a>                <span class="k">return</span> <span class="n">SnapshotResult</span><span class="p">(</span>
</span><span id="HtWrapper-288"><a href="#HtWrapper-288"><span class="linenos">288</span></a>                    <span class="n">text</span><span class="o">=</span><span class="n">snapshot_text</span><span class="p">,</span>
</span><span id="HtWrapper-289"><a href="#HtWrapper-289"><span class="linenos">289</span></a>                    <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="p">,</span>
</span><span id="HtWrapper-290"><a href="#HtWrapper-290"><span class="linenos">290</span></a>                    <span class="n">raw_seq</span><span class="o">=</span><span class="n">raw_seq</span><span class="p">,</span>
</span><span id="HtWrapper-291"><a href="#HtWrapper-291"><span class="linenos">291</span></a>                <span class="p">)</span>
</span><span id="HtWrapper-292"><a href="#HtWrapper-292"><span class="linenos">292</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-293"><a href="#HtWrapper-293"><span class="linenos">293</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-294"><a href="#HtWrapper-294"><span class="linenos">294</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;resize&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-295"><a href="#HtWrapper-295"><span class="linenos">295</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="HtWrapper-296"><a href="#HtWrapper-296"><span class="linenos">296</span></a>                <span class="k">if</span> <span class="s2">&quot;rows&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="HtWrapper-297"><a href="#HtWrapper-297"><span class="linenos">297</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span>
</span><span id="HtWrapper-298"><a href="#HtWrapper-298"><span class="linenos">298</span></a>                <span class="k">if</span> <span class="s2">&quot;cols&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="HtWrapper-299"><a href="#HtWrapper-299"><span class="linenos">299</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cols</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">]</span>
</span><span id="HtWrapper-300"><a href="#HtWrapper-300"><span class="linenos">300</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-301"><a href="#HtWrapper-301"><span class="linenos">301</span></a>                <span class="k">pass</span>
</span><span id="HtWrapper-302"><a href="#HtWrapper-302"><span class="linenos">302</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper-303"><a href="#HtWrapper-303"><span class="linenos">303</span></a>                <span class="c1"># Put non-snapshot events back in queue for reader thread to handle</span>
</span><span id="HtWrapper-304"><a href="#HtWrapper-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-305"><a href="#HtWrapper-305"><span class="linenos">305</span></a>
</span><span id="HtWrapper-306"><a href="#HtWrapper-306"><span class="linenos">306</span></a>            <span class="c1"># If we get here, we didn&#39;t find a snapshot, so retry</span>
</span><span id="HtWrapper-307"><a href="#HtWrapper-307"><span class="linenos">307</span></a>            <span class="k">raise</span> <span class="n">SnapshotNotReady</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> event, waiting for snapshot&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-308"><a href="#HtWrapper-308"><span class="linenos">308</span></a>
</span><span id="HtWrapper-309"><a href="#HtWrapper-309"><span class="linenos">309</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-310"><a href="#HtWrapper-310"><span class="linenos">310</span></a>            <span class="k">return</span> <span class="n">_get_snapshot</span><span class="p">()</span>
</span><span id="HtWrapper-311"><a href="#HtWrapper-311"><span class="linenos">311</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-312"><a href="#HtWrapper-312"><span class="linenos">312</span></a>            <span class="c1"># Handle both direct SnapshotNotReady and tenacity RetryError</span>
</span><span id="HtWrapper-313"><a href="#HtWrapper-313"><span class="linenos">313</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">tenacity</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryError</span>
</span><span id="HtWrapper-314"><a href="#HtWrapper-314"><span class="linenos">314</span></a>
</span><span id="HtWrapper-315"><a href="#HtWrapper-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">SnapshotNotReady</span><span class="p">,</span> <span class="n">RetryError</span><span class="p">)):</span>
</span><span id="HtWrapper-316"><a href="#HtWrapper-316"><span class="linenos">316</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="HtWrapper-317"><a href="#HtWrapper-317"><span class="linenos">317</span></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to receive snapshot event within </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds. &quot;</span>
</span><span id="HtWrapper-318"><a href="#HtWrapper-318"><span class="linenos">318</span></a>                    <span class="sa">f</span><span class="s2">&quot;ht process may have exited or stopped responding.&quot;</span>
</span><span id="HtWrapper-319"><a href="#HtWrapper-319"><span class="linenos">319</span></a>                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper-320"><a href="#HtWrapper-320"><span class="linenos">320</span></a>            <span class="k">raise</span>
</span><span id="HtWrapper-321"><a href="#HtWrapper-321"><span class="linenos">321</span></a>
</span><span id="HtWrapper-322"><a href="#HtWrapper-322"><span class="linenos">322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_EXIT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="HtWrapper-323"><a href="#HtWrapper-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-324"><a href="#HtWrapper-324"><span class="linenos">324</span></a><span class="sd">        Exit the ht process, ensuring clean shutdown.</span>
</span><span id="HtWrapper-325"><a href="#HtWrapper-325"><span class="linenos">325</span></a>
</span><span id="HtWrapper-326"><a href="#HtWrapper-326"><span class="linenos">326</span></a><span class="sd">        Uses different strategies based on subprocess state:</span>
</span><span id="HtWrapper-327"><a href="#HtWrapper-327"><span class="linenos">327</span></a><span class="sd">        - If subprocess already exited (exitCode event received): graceful shutdown via exit command</span>
</span><span id="HtWrapper-328"><a href="#HtWrapper-328"><span class="linenos">328</span></a><span class="sd">        - If subprocess still running: forced termination with SIGTERM then SIGKILL</span>
</span><span id="HtWrapper-329"><a href="#HtWrapper-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-330"><a href="#HtWrapper-330"><span class="linenos">330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exiting HTProcess: ht_proc.pid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-331"><a href="#HtWrapper-331"><span class="linenos">331</span></a>
</span><span id="HtWrapper-332"><a href="#HtWrapper-332"><span class="linenos">332</span></a>        <span class="c1"># Check if we&#39;ve already received the exitCode event</span>
</span><span id="HtWrapper-333"><a href="#HtWrapper-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span><span class="p">:</span>
</span><span id="HtWrapper-334"><a href="#HtWrapper-334"><span class="linenos">334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess already exited (exitCode event received), attempting graceful shutdown&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-335"><a href="#HtWrapper-335"><span class="linenos">335</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graceful_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper-336"><a href="#HtWrapper-336"><span class="linenos">336</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper-337"><a href="#HtWrapper-337"><span class="linenos">337</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess has not exited yet, checking current state&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-338"><a href="#HtWrapper-338"><span class="linenos">338</span></a>
</span><span id="HtWrapper-339"><a href="#HtWrapper-339"><span class="linenos">339</span></a>            <span class="c1"># Give a brief moment for any pending exitCode event to arrive</span>
</span><span id="HtWrapper-340"><a href="#HtWrapper-340"><span class="linenos">340</span></a>            <span class="n">brief_wait_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-341"><a href="#HtWrapper-341"><span class="linenos">341</span></a>            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">brief_wait_start</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Wait up to 500ms</span>
</span><span id="HtWrapper-342"><a href="#HtWrapper-342"><span class="linenos">342</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span><span class="p">:</span>
</span><span id="HtWrapper-343"><a href="#HtWrapper-343"><span class="linenos">343</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess exited during brief wait, attempting graceful shutdown&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-344"><a href="#HtWrapper-344"><span class="linenos">344</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graceful_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper-345"><a href="#HtWrapper-345"><span class="linenos">345</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="HtWrapper-346"><a href="#HtWrapper-346"><span class="linenos">346</span></a>
</span><span id="HtWrapper-347"><a href="#HtWrapper-347"><span class="linenos">347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess still running after brief wait, using forced termination&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-348"><a href="#HtWrapper-348"><span class="linenos">348</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forced_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper-349"><a href="#HtWrapper-349"><span class="linenos">349</span></a>
</span><span id="HtWrapper-350"><a href="#HtWrapper-350"><span class="linenos">350</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_graceful_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="HtWrapper-351"><a href="#HtWrapper-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-352"><a href="#HtWrapper-352"><span class="linenos">352</span></a><span class="sd">        Graceful exit: subprocess has completed, so we can send exit command to ht process.</span>
</span><span id="HtWrapper-353"><a href="#HtWrapper-353"><span class="linenos">353</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-354"><a href="#HtWrapper-354"><span class="linenos">354</span></a>        <span class="c1"># Send exit command to ht process</span>
</span><span id="HtWrapper-355"><a href="#HtWrapper-355"><span class="linenos">355</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;exit&quot;</span><span class="p">})</span>
</span><span id="HtWrapper-356"><a href="#HtWrapper-356"><span class="linenos">356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending exit command to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-357"><a href="#HtWrapper-357"><span class="linenos">357</span></a>
</span><span id="HtWrapper-358"><a href="#HtWrapper-358"><span class="linenos">358</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-359"><a href="#HtWrapper-359"><span class="linenos">359</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-360"><a href="#HtWrapper-360"><span class="linenos">360</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-361"><a href="#HtWrapper-361"><span class="linenos">361</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="HtWrapper-362"><a href="#HtWrapper-362"><span class="linenos">362</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exit command sent successfully to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-363"><a href="#HtWrapper-363"><span class="linenos">363</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close stdin after sending exit command</span>
</span><span id="HtWrapper-364"><a href="#HtWrapper-364"><span class="linenos">364</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed stdin for ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-365"><a href="#HtWrapper-365"><span class="linenos">365</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper-366"><a href="#HtWrapper-366"><span class="linenos">366</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> stdin is None, cannot send exit command&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-367"><a href="#HtWrapper-367"><span class="linenos">367</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">BrokenPipeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-368"><a href="#HtWrapper-368"><span class="linenos">368</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="HtWrapper-369"><a href="#HtWrapper-369"><span class="linenos">369</span></a>                <span class="sa">f</span><span class="s2">&quot;Failed to send exit command to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (process may have already exited)&quot;</span>
</span><span id="HtWrapper-370"><a href="#HtWrapper-370"><span class="linenos">370</span></a>            <span class="p">)</span>
</span><span id="HtWrapper-371"><a href="#HtWrapper-371"><span class="linenos">371</span></a>            <span class="k">pass</span>
</span><span id="HtWrapper-372"><a href="#HtWrapper-372"><span class="linenos">372</span></a>
</span><span id="HtWrapper-373"><a href="#HtWrapper-373"><span class="linenos">373</span></a>        <span class="c1"># Wait for the ht process to finish gracefully</span>
</span><span id="HtWrapper-374"><a href="#HtWrapper-374"><span class="linenos">374</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-375"><a href="#HtWrapper-375"><span class="linenos">375</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-376"><a href="#HtWrapper-376"><span class="linenos">376</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper-377"><a href="#HtWrapper-377"><span class="linenos">377</span></a>                <span class="c1"># Graceful exit timed out, fall back to forced termination</span>
</span><span id="HtWrapper-378"><a href="#HtWrapper-378"><span class="linenos">378</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="HtWrapper-379"><a href="#HtWrapper-379"><span class="linenos">379</span></a>                    <span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> did not exit gracefully within timeout, &quot;</span>
</span><span id="HtWrapper-380"><a href="#HtWrapper-380"><span class="linenos">380</span></a>                    <span class="sa">f</span><span class="s2">&quot;falling back to forced termination&quot;</span>
</span><span id="HtWrapper-381"><a href="#HtWrapper-381"><span class="linenos">381</span></a>                <span class="p">)</span>
</span><span id="HtWrapper-382"><a href="#HtWrapper-382"><span class="linenos">382</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forced_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper-383"><a href="#HtWrapper-383"><span class="linenos">383</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="HtWrapper-384"><a href="#HtWrapper-384"><span class="linenos">384</span></a>
</span><span id="HtWrapper-385"><a href="#HtWrapper-385"><span class="linenos">385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span>
</span><span id="HtWrapper-386"><a href="#HtWrapper-386"><span class="linenos">386</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-387"><a href="#HtWrapper-387"><span class="linenos">387</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to determine ht process exit code&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-388"><a href="#HtWrapper-388"><span class="linenos">388</span></a>
</span><span id="HtWrapper-389"><a href="#HtWrapper-389"><span class="linenos">389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTProcess exited gracefully: exit_code=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-390"><a href="#HtWrapper-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span>
</span><span id="HtWrapper-391"><a href="#HtWrapper-391"><span class="linenos">391</span></a>
</span><span id="HtWrapper-392"><a href="#HtWrapper-392"><span class="linenos">392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_forced_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="HtWrapper-393"><a href="#HtWrapper-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-394"><a href="#HtWrapper-394"><span class="linenos">394</span></a><span class="sd">        Forced exit: subprocess may still be running, so we need to terminate everything forcefully.</span>
</span><span id="HtWrapper-395"><a href="#HtWrapper-395"><span class="linenos">395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-396"><a href="#HtWrapper-396"><span class="linenos">396</span></a>        <span class="c1"># Step 1: Ensure subprocess is terminated first if needed</span>
</span><span id="HtWrapper-397"><a href="#HtWrapper-397"><span class="linenos">397</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">pid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span><span class="p">:</span>
</span><span id="HtWrapper-398"><a href="#HtWrapper-398"><span class="linenos">398</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminating subprocess: pid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-399"><a href="#HtWrapper-399"><span class="linenos">399</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-400"><a href="#HtWrapper-400"><span class="linenos">400</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="HtWrapper-401"><a href="#HtWrapper-401"><span class="linenos">401</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="HtWrapper-402"><a href="#HtWrapper-402"><span class="linenos">402</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-403"><a href="#HtWrapper-403"><span class="linenos">403</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_SUBPROCESS_WAIT_TIMEOUT</span><span class="p">)</span>
</span><span id="HtWrapper-404"><a href="#HtWrapper-404"><span class="linenos">404</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subprocess </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> terminated successfully&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-405"><a href="#HtWrapper-405"><span class="linenos">405</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="HtWrapper-406"><a href="#HtWrapper-406"><span class="linenos">406</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subprocess </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> did not terminate gracefully, killing&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-407"><a href="#HtWrapper-407"><span class="linenos">407</span></a>                    <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="HtWrapper-408"><a href="#HtWrapper-408"><span class="linenos">408</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="HtWrapper-409"><a href="#HtWrapper-409"><span class="linenos">409</span></a>            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="HtWrapper-410"><a href="#HtWrapper-410"><span class="linenos">410</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subprocess </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> already exited&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-411"><a href="#HtWrapper-411"><span class="linenos">411</span></a>                <span class="k">pass</span>  <span class="c1"># Process already exited</span>
</span><span id="HtWrapper-412"><a href="#HtWrapper-412"><span class="linenos">412</span></a>
</span><span id="HtWrapper-413"><a href="#HtWrapper-413"><span class="linenos">413</span></a>        <span class="c1"># Step 2: Force terminate the ht process with SIGTERM, then SIGKILL if needed</span>
</span><span id="HtWrapper-414"><a href="#HtWrapper-414"><span class="linenos">414</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Force terminating ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-415"><a href="#HtWrapper-415"><span class="linenos">415</span></a>
</span><span id="HtWrapper-416"><a href="#HtWrapper-416"><span class="linenos">416</span></a>        <span class="c1"># Try SIGTERM first</span>
</span><span id="HtWrapper-417"><a href="#HtWrapper-417"><span class="linenos">417</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-418"><a href="#HtWrapper-418"><span class="linenos">418</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="HtWrapper-419"><a href="#HtWrapper-419"><span class="linenos">419</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent SIGTERM to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-420"><a href="#HtWrapper-420"><span class="linenos">420</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-421"><a href="#HtWrapper-421"><span class="linenos">421</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send SIGTERM to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-422"><a href="#HtWrapper-422"><span class="linenos">422</span></a>
</span><span id="HtWrapper-423"><a href="#HtWrapper-423"><span class="linenos">423</span></a>        <span class="c1"># Wait for termination</span>
</span><span id="HtWrapper-424"><a href="#HtWrapper-424"><span class="linenos">424</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-425"><a href="#HtWrapper-425"><span class="linenos">425</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-426"><a href="#HtWrapper-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper-427"><a href="#HtWrapper-427"><span class="linenos">427</span></a>                <span class="c1"># SIGTERM timeout, try SIGKILL</span>
</span><span id="HtWrapper-428"><a href="#HtWrapper-428"><span class="linenos">428</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="HtWrapper-429"><a href="#HtWrapper-429"><span class="linenos">429</span></a>                    <span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> did not terminate with SIGTERM within timeout, sending SIGKILL&quot;</span>
</span><span id="HtWrapper-430"><a href="#HtWrapper-430"><span class="linenos">430</span></a>                <span class="p">)</span>
</span><span id="HtWrapper-431"><a href="#HtWrapper-431"><span class="linenos">431</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-432"><a href="#HtWrapper-432"><span class="linenos">432</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="HtWrapper-433"><a href="#HtWrapper-433"><span class="linenos">433</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent SIGKILL to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-434"><a href="#HtWrapper-434"><span class="linenos">434</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-435"><a href="#HtWrapper-435"><span class="linenos">435</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send SIGKILL to ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-436"><a href="#HtWrapper-436"><span class="linenos">436</span></a>
</span><span id="HtWrapper-437"><a href="#HtWrapper-437"><span class="linenos">437</span></a>                <span class="c1"># Wait for SIGKILL to take effect</span>
</span><span id="HtWrapper-438"><a href="#HtWrapper-438"><span class="linenos">438</span></a>                <span class="n">kill_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-439"><a href="#HtWrapper-439"><span class="linenos">439</span></a>                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-440"><a href="#HtWrapper-440"><span class="linenos">440</span></a>                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">kill_start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper-441"><a href="#HtWrapper-441"><span class="linenos">441</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> did not respond to SIGKILL within timeout&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-442"><a href="#HtWrapper-442"><span class="linenos">442</span></a>                        <span class="k">break</span>
</span><span id="HtWrapper-443"><a href="#HtWrapper-443"><span class="linenos">443</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="HtWrapper-444"><a href="#HtWrapper-444"><span class="linenos">444</span></a>                <span class="k">break</span>
</span><span id="HtWrapper-445"><a href="#HtWrapper-445"><span class="linenos">445</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="HtWrapper-446"><a href="#HtWrapper-446"><span class="linenos">446</span></a>
</span><span id="HtWrapper-447"><a href="#HtWrapper-447"><span class="linenos">447</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span>
</span><span id="HtWrapper-448"><a href="#HtWrapper-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-449"><a href="#HtWrapper-449"><span class="linenos">449</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to determine ht process exit code&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-450"><a href="#HtWrapper-450"><span class="linenos">450</span></a>
</span><span id="HtWrapper-451"><a href="#HtWrapper-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTProcess exited via forced termination: exit_code=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-452"><a href="#HtWrapper-452"><span class="linenos">452</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit_code</span>
</span><span id="HtWrapper-453"><a href="#HtWrapper-453"><span class="linenos">453</span></a>
</span><span id="HtWrapper-454"><a href="#HtWrapper-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_EXPECT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-455"><a href="#HtWrapper-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-456"><a href="#HtWrapper-456"><span class="linenos">456</span></a><span class="sd">        Wait for a regex pattern to appear in the terminal output.</span>
</span><span id="HtWrapper-457"><a href="#HtWrapper-457"><span class="linenos">457</span></a>
</span><span id="HtWrapper-458"><a href="#HtWrapper-458"><span class="linenos">458</span></a><span class="sd">        This method efficiently waits for output by monitoring the output events from</span>
</span><span id="HtWrapper-459"><a href="#HtWrapper-459"><span class="linenos">459</span></a><span class="sd">        the ht process rather than polling with snapshots. It checks both the current</span>
</span><span id="HtWrapper-460"><a href="#HtWrapper-460"><span class="linenos">460</span></a><span class="sd">        terminal state (via snapshot) and any new output that arrives.</span>
</span><span id="HtWrapper-461"><a href="#HtWrapper-461"><span class="linenos">461</span></a>
</span><span id="HtWrapper-462"><a href="#HtWrapper-462"><span class="linenos">462</span></a><span class="sd">        Args:</span>
</span><span id="HtWrapper-463"><a href="#HtWrapper-463"><span class="linenos">463</span></a><span class="sd">            pattern: The regex pattern to look for in the terminal output</span>
</span><span id="HtWrapper-464"><a href="#HtWrapper-464"><span class="linenos">464</span></a><span class="sd">            timeout: Maximum time to wait in seconds (default: 5.0)</span>
</span><span id="HtWrapper-465"><a href="#HtWrapper-465"><span class="linenos">465</span></a>
</span><span id="HtWrapper-466"><a href="#HtWrapper-466"><span class="linenos">466</span></a><span class="sd">        Raises:</span>
</span><span id="HtWrapper-467"><a href="#HtWrapper-467"><span class="linenos">467</span></a><span class="sd">            TimeoutError: If the pattern doesn&#39;t appear within the timeout period</span>
</span><span id="HtWrapper-468"><a href="#HtWrapper-468"><span class="linenos">468</span></a><span class="sd">            RuntimeError: If the ht process has exited</span>
</span><span id="HtWrapper-469"><a href="#HtWrapper-469"><span class="linenos">469</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-470"><a href="#HtWrapper-470"><span class="linenos">470</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-471"><a href="#HtWrapper-471"><span class="linenos">471</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process has exited with code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-472"><a href="#HtWrapper-472"><span class="linenos">472</span></a>
</span><span id="HtWrapper-473"><a href="#HtWrapper-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting regex pattern: &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-474"><a href="#HtWrapper-474"><span class="linenos">474</span></a>
</span><span id="HtWrapper-475"><a href="#HtWrapper-475"><span class="linenos">475</span></a>        <span class="c1"># Compile the regex pattern</span>
</span><span id="HtWrapper-476"><a href="#HtWrapper-476"><span class="linenos">476</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-477"><a href="#HtWrapper-477"><span class="linenos">477</span></a>            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span id="HtWrapper-478"><a href="#HtWrapper-478"><span class="linenos">478</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-479"><a href="#HtWrapper-479"><span class="linenos">479</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper-480"><a href="#HtWrapper-480"><span class="linenos">480</span></a>
</span><span id="HtWrapper-481"><a href="#HtWrapper-481"><span class="linenos">481</span></a>        <span class="c1"># First check current terminal state</span>
</span><span id="HtWrapper-482"><a href="#HtWrapper-482"><span class="linenos">482</span></a>        <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</span><span id="HtWrapper-483"><a href="#HtWrapper-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span id="HtWrapper-484"><a href="#HtWrapper-484"><span class="linenos">484</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found immediately in current terminal state&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-485"><a href="#HtWrapper-485"><span class="linenos">485</span></a>            <span class="k">return</span>
</span><span id="HtWrapper-486"><a href="#HtWrapper-486"><span class="linenos">486</span></a>
</span><span id="HtWrapper-487"><a href="#HtWrapper-487"><span class="linenos">487</span></a>        <span class="c1"># Start time for timeout tracking</span>
</span><span id="HtWrapper-488"><a href="#HtWrapper-488"><span class="linenos">488</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-489"><a href="#HtWrapper-489"><span class="linenos">489</span></a>
</span><span id="HtWrapper-490"><a href="#HtWrapper-490"><span class="linenos">490</span></a>        <span class="c1"># Process events until we find the pattern or timeout</span>
</span><span id="HtWrapper-491"><a href="#HtWrapper-491"><span class="linenos">491</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="HtWrapper-492"><a href="#HtWrapper-492"><span class="linenos">492</span></a>            <span class="c1"># Check timeout</span>
</span><span id="HtWrapper-493"><a href="#HtWrapper-493"><span class="linenos">493</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper-494"><a href="#HtWrapper-494"><span class="linenos">494</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; not found in terminal output after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-495"><a href="#HtWrapper-495"><span class="linenos">495</span></a>                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; not found within </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-496"><a href="#HtWrapper-496"><span class="linenos">496</span></a>
</span><span id="HtWrapper-497"><a href="#HtWrapper-497"><span class="linenos">497</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-498"><a href="#HtWrapper-498"><span class="linenos">498</span></a>                <span class="c1"># Wait for next event with a short timeout to allow checking the overall timeout</span>
</span><span id="HtWrapper-499"><a href="#HtWrapper-499"><span class="linenos">499</span></a>                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="HtWrapper-500"><a href="#HtWrapper-500"><span class="linenos">500</span></a>            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="HtWrapper-501"><a href="#HtWrapper-501"><span class="linenos">501</span></a>                <span class="k">continue</span>
</span><span id="HtWrapper-502"><a href="#HtWrapper-502"><span class="linenos">502</span></a>
</span><span id="HtWrapper-503"><a href="#HtWrapper-503"><span class="linenos">503</span></a>            <span class="c1"># Process the event</span>
</span><span id="HtWrapper-504"><a href="#HtWrapper-504"><span class="linenos">504</span></a>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-505"><a href="#HtWrapper-505"><span class="linenos">505</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-506"><a href="#HtWrapper-506"><span class="linenos">506</span></a>                <span class="c1"># Check if pattern appears in this output</span>
</span><span id="HtWrapper-507"><a href="#HtWrapper-507"><span class="linenos">507</span></a>                <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">&quot;seq&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;seq&quot;</span><span class="p">]):</span>
</span><span id="HtWrapper-508"><a href="#HtWrapper-508"><span class="linenos">508</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in output event&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-509"><a href="#HtWrapper-509"><span class="linenos">509</span></a>                    <span class="k">return</span>
</span><span id="HtWrapper-510"><a href="#HtWrapper-510"><span class="linenos">510</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;exitCode&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-511"><a href="#HtWrapper-511"><span class="linenos">511</span></a>                <span class="c1"># Put back in queue for reader thread to handle</span>
</span><span id="HtWrapper-512"><a href="#HtWrapper-512"><span class="linenos">512</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-513"><a href="#HtWrapper-513"><span class="linenos">513</span></a>                <span class="c1"># Don&#39;t raise here - the process might have exited after outputting what we want</span>
</span><span id="HtWrapper-514"><a href="#HtWrapper-514"><span class="linenos">514</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-515"><a href="#HtWrapper-515"><span class="linenos">515</span></a>                <span class="c1"># If we get a snapshot event, check its content</span>
</span><span id="HtWrapper-516"><a href="#HtWrapper-516"><span class="linenos">516</span></a>                <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]):</span>
</span><span id="HtWrapper-517"><a href="#HtWrapper-517"><span class="linenos">517</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in snapshot event&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-518"><a href="#HtWrapper-518"><span class="linenos">518</span></a>                    <span class="k">return</span>
</span><span id="HtWrapper-519"><a href="#HtWrapper-519"><span class="linenos">519</span></a>
</span><span id="HtWrapper-520"><a href="#HtWrapper-520"><span class="linenos">520</span></a>            <span class="c1"># Take a new snapshot periodically to catch any missed output</span>
</span><span id="HtWrapper-521"><a href="#HtWrapper-521"><span class="linenos">521</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Every 10 events</span>
</span><span id="HtWrapper-522"><a href="#HtWrapper-522"><span class="linenos">522</span></a>                <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</span><span id="HtWrapper-523"><a href="#HtWrapper-523"><span class="linenos">523</span></a>                <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span id="HtWrapper-524"><a href="#HtWrapper-524"><span class="linenos">524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in periodic snapshot&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-525"><a href="#HtWrapper-525"><span class="linenos">525</span></a>                    <span class="k">return</span>
</span><span id="HtWrapper-526"><a href="#HtWrapper-526"><span class="linenos">526</span></a>
</span><span id="HtWrapper-527"><a href="#HtWrapper-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expect_absent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_EXPECT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-528"><a href="#HtWrapper-528"><span class="linenos">528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper-529"><a href="#HtWrapper-529"><span class="linenos">529</span></a><span class="sd">        Wait for a regex pattern to disappear from the terminal output.</span>
</span><span id="HtWrapper-530"><a href="#HtWrapper-530"><span class="linenos">530</span></a>
</span><span id="HtWrapper-531"><a href="#HtWrapper-531"><span class="linenos">531</span></a><span class="sd">        This method efficiently waits for output changes by monitoring the output events</span>
</span><span id="HtWrapper-532"><a href="#HtWrapper-532"><span class="linenos">532</span></a><span class="sd">        from the ht process rather than polling with snapshots. It periodically checks</span>
</span><span id="HtWrapper-533"><a href="#HtWrapper-533"><span class="linenos">533</span></a><span class="sd">        the terminal state to verify the pattern is gone.</span>
</span><span id="HtWrapper-534"><a href="#HtWrapper-534"><span class="linenos">534</span></a>
</span><span id="HtWrapper-535"><a href="#HtWrapper-535"><span class="linenos">535</span></a><span class="sd">        Args:</span>
</span><span id="HtWrapper-536"><a href="#HtWrapper-536"><span class="linenos">536</span></a><span class="sd">            pattern: The regex pattern that should disappear from the terminal output</span>
</span><span id="HtWrapper-537"><a href="#HtWrapper-537"><span class="linenos">537</span></a><span class="sd">            timeout: Maximum time to wait in seconds (default: 5.0)</span>
</span><span id="HtWrapper-538"><a href="#HtWrapper-538"><span class="linenos">538</span></a>
</span><span id="HtWrapper-539"><a href="#HtWrapper-539"><span class="linenos">539</span></a><span class="sd">        Raises:</span>
</span><span id="HtWrapper-540"><a href="#HtWrapper-540"><span class="linenos">540</span></a><span class="sd">            TimeoutError: If the pattern doesn&#39;t disappear within the timeout period</span>
</span><span id="HtWrapper-541"><a href="#HtWrapper-541"><span class="linenos">541</span></a><span class="sd">            RuntimeError: If the ht process has exited</span>
</span><span id="HtWrapper-542"><a href="#HtWrapper-542"><span class="linenos">542</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper-543"><a href="#HtWrapper-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper-544"><a href="#HtWrapper-544"><span class="linenos">544</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process has exited with code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-545"><a href="#HtWrapper-545"><span class="linenos">545</span></a>
</span><span id="HtWrapper-546"><a href="#HtWrapper-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting regex pattern to disappear: &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-547"><a href="#HtWrapper-547"><span class="linenos">547</span></a>
</span><span id="HtWrapper-548"><a href="#HtWrapper-548"><span class="linenos">548</span></a>        <span class="c1"># Compile the regex pattern</span>
</span><span id="HtWrapper-549"><a href="#HtWrapper-549"><span class="linenos">549</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-550"><a href="#HtWrapper-550"><span class="linenos">550</span></a>            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span id="HtWrapper-551"><a href="#HtWrapper-551"><span class="linenos">551</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper-552"><a href="#HtWrapper-552"><span class="linenos">552</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper-553"><a href="#HtWrapper-553"><span class="linenos">553</span></a>
</span><span id="HtWrapper-554"><a href="#HtWrapper-554"><span class="linenos">554</span></a>        <span class="c1"># Start time for timeout tracking</span>
</span><span id="HtWrapper-555"><a href="#HtWrapper-555"><span class="linenos">555</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper-556"><a href="#HtWrapper-556"><span class="linenos">556</span></a>
</span><span id="HtWrapper-557"><a href="#HtWrapper-557"><span class="linenos">557</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="HtWrapper-558"><a href="#HtWrapper-558"><span class="linenos">558</span></a>            <span class="c1"># Take a snapshot to check current state</span>
</span><span id="HtWrapper-559"><a href="#HtWrapper-559"><span class="linenos">559</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</span><span id="HtWrapper-560"><a href="#HtWrapper-560"><span class="linenos">560</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span id="HtWrapper-561"><a href="#HtWrapper-561"><span class="linenos">561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; is now absent from terminal output&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-562"><a href="#HtWrapper-562"><span class="linenos">562</span></a>                <span class="k">return</span>
</span><span id="HtWrapper-563"><a href="#HtWrapper-563"><span class="linenos">563</span></a>
</span><span id="HtWrapper-564"><a href="#HtWrapper-564"><span class="linenos">564</span></a>            <span class="c1"># Check timeout</span>
</span><span id="HtWrapper-565"><a href="#HtWrapper-565"><span class="linenos">565</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper-566"><a href="#HtWrapper-566"><span class="linenos">566</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; still present in terminal output after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-567"><a href="#HtWrapper-567"><span class="linenos">567</span></a>                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; still present after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper-568"><a href="#HtWrapper-568"><span class="linenos">568</span></a>
</span><span id="HtWrapper-569"><a href="#HtWrapper-569"><span class="linenos">569</span></a>            <span class="c1"># Wait for next event with a short timeout</span>
</span><span id="HtWrapper-570"><a href="#HtWrapper-570"><span class="linenos">570</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper-571"><a href="#HtWrapper-571"><span class="linenos">571</span></a>                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="HtWrapper-572"><a href="#HtWrapper-572"><span class="linenos">572</span></a>            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="HtWrapper-573"><a href="#HtWrapper-573"><span class="linenos">573</span></a>                <span class="k">continue</span>
</span><span id="HtWrapper-574"><a href="#HtWrapper-574"><span class="linenos">574</span></a>
</span><span id="HtWrapper-575"><a href="#HtWrapper-575"><span class="linenos">575</span></a>            <span class="c1"># Process the event</span>
</span><span id="HtWrapper-576"><a href="#HtWrapper-576"><span class="linenos">576</span></a>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-577"><a href="#HtWrapper-577"><span class="linenos">577</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-578"><a href="#HtWrapper-578"><span class="linenos">578</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;exitCode&quot;</span><span class="p">:</span>
</span><span id="HtWrapper-579"><a href="#HtWrapper-579"><span class="linenos">579</span></a>                <span class="c1"># Put back in queue for reader thread to handle</span>
</span><span id="HtWrapper-580"><a href="#HtWrapper-580"><span class="linenos">580</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper-581"><a href="#HtWrapper-581"><span class="linenos">581</span></a>                <span class="c1"># Don&#39;t raise here - the process might have exited after the pattern disappeared</span>
</span></pre></div>


            <div class="docstring"><p>A wrapper around a process started with the 'ht' tool that provides
methods for interacting with the process and capturing its output.</p>
</div>


                            <div id="HtWrapper.ht" class="classattr">
                                <div class="attr variable">
            <span class="name">ht</span><span class="annotation">: <a href="#ProcessController">ProcessController</a></span>

        
    </div>
    <a class="headerlink" href="#HtWrapper.ht"></a>
    
            <div class="docstring"><p>Helpers for interacting with the <code><a href="#HtWrapper.ht">ht</a></code> process (a child process of the python
that called <code><a href="#run">htty.run</a></code> or <code><a href="#terminal_session">htty.terminal_session</a></code>)</p>
</div>


                            </div>
                            <div id="HtWrapper.cmd" class="classattr">
                                <div class="attr variable">
            <span class="name">cmd</span><span class="annotation">: <a href="#ProcessController">ProcessController</a></span>

        
    </div>
    <a class="headerlink" href="#HtWrapper.cmd"></a>
    
            <div class="docstring"><p>Helpers for interacting with the shell that wraps the caller's command (<code><a href="#HtWrapper.ht">ht</a></code>'s child process)</p>
</div>


                            </div>
                            <div id="HtWrapper.get_output" class="classattr">
                                        <input id="HtWrapper.get_output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_output</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="HtWrapper.get_output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper.get_output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper.get_output-147"><a href="#HtWrapper.get_output-147"><span class="linenos">147</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="HtWrapper.get_output-148"><a href="#HtWrapper.get_output-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper.get_output-149"><a href="#HtWrapper.get_output-149"><span class="linenos">149</span></a><span class="sd">        Return list of [output](./htty-core/htty_core.html#HtEvent.OUTPUT) events.&quot;&quot;&quot;</span>
</span><span id="HtWrapper.get_output-150"><a href="#HtWrapper.get_output-150"><span class="linenos">150</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">event</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return list of <a href="./htty-core/htty_core.html#HtEvent.OUTPUT">output</a> events.</p>
</div>


                            </div>
                            <div id="HtWrapper.send_keys" class="classattr">
                                        <input id="HtWrapper.send_keys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_keys</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">htty</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">Press</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">htty</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">Press</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HtWrapper.send_keys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper.send_keys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper.send_keys-174"><a href="#HtWrapper.send_keys-174"><span class="linenos">174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">KeyInput</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">KeyInput</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.send_keys-175"><a href="#HtWrapper.send_keys-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper.send_keys-176"><a href="#HtWrapper.send_keys-176"><span class="linenos">176</span></a><span class="sd">        Send keys to the terminal.  Accepts strings, `Press` objects, and lists of strings or `Press` objects.</span>
</span><span id="HtWrapper.send_keys-177"><a href="#HtWrapper.send_keys-177"><span class="linenos">177</span></a><span class="sd">        For keys that you can `Press`, see</span>
</span><span id="HtWrapper.send_keys-178"><a href="#HtWrapper.send_keys-178"><span class="linenos">178</span></a><span class="sd">        [keys.py](https://github.com/MatrixManAtYrService/htty/blob/main/htty/src/htty/keys.py).</span>
</span><span id="HtWrapper.send_keys-179"><a href="#HtWrapper.send_keys-179"><span class="linenos">179</span></a>
</span><span id="HtWrapper.send_keys-180"><a href="#HtWrapper.send_keys-180"><span class="linenos">180</span></a><span class="sd">        ```python</span>
</span><span id="HtWrapper.send_keys-181"><a href="#HtWrapper.send_keys-181"><span class="linenos">181</span></a><span class="sd">        from htty import Press, terminal_session</span>
</span><span id="HtWrapper.send_keys-182"><a href="#HtWrapper.send_keys-182"><span class="linenos">182</span></a>
</span><span id="HtWrapper.send_keys-183"><a href="#HtWrapper.send_keys-183"><span class="linenos">183</span></a><span class="sd">        with (</span>
</span><span id="HtWrapper.send_keys-184"><a href="#HtWrapper.send_keys-184"><span class="linenos">184</span></a><span class="sd">            terminal_session(&quot;sh -i&quot;, rows=4, cols=40, logger=test_logger) as sh,</span>
</span><span id="HtWrapper.send_keys-185"><a href="#HtWrapper.send_keys-185"><span class="linenos">185</span></a><span class="sd">        ):</span>
</span><span id="HtWrapper.send_keys-186"><a href="#HtWrapper.send_keys-186"><span class="linenos">186</span></a><span class="sd">            sh.send_keys(&quot;echo foo &amp;&amp; sleep 999&quot;)</span>
</span><span id="HtWrapper.send_keys-187"><a href="#HtWrapper.send_keys-187"><span class="linenos">187</span></a><span class="sd">            sh.send_keys(Press.ENTER)</span>
</span><span id="HtWrapper.send_keys-188"><a href="#HtWrapper.send_keys-188"><span class="linenos">188</span></a><span class="sd">            sh.expect(&quot;^foo&quot;)</span>
</span><span id="HtWrapper.send_keys-189"><a href="#HtWrapper.send_keys-189"><span class="linenos">189</span></a><span class="sd">            sh.send_keys(Press.CTRL_Z)</span>
</span><span id="HtWrapper.send_keys-190"><a href="#HtWrapper.send_keys-190"><span class="linenos">190</span></a><span class="sd">            sh.expect(&quot;Stopped&quot;)</span>
</span><span id="HtWrapper.send_keys-191"><a href="#HtWrapper.send_keys-191"><span class="linenos">191</span></a><span class="sd">            sh.send_keys([&quot;clear&quot;, Press.ENTER])</span>
</span><span id="HtWrapper.send_keys-192"><a href="#HtWrapper.send_keys-192"><span class="linenos">192</span></a><span class="sd">        ```</span>
</span><span id="HtWrapper.send_keys-193"><a href="#HtWrapper.send_keys-193"><span class="linenos">193</span></a>
</span><span id="HtWrapper.send_keys-194"><a href="#HtWrapper.send_keys-194"><span class="linenos">194</span></a><span class="sd">        These are sent to `ht` as events that look like this</span>
</span><span id="HtWrapper.send_keys-195"><a href="#HtWrapper.send_keys-195"><span class="linenos">195</span></a>
</span><span id="HtWrapper.send_keys-196"><a href="#HtWrapper.send_keys-196"><span class="linenos">196</span></a><span class="sd">        ```json</span>
</span><span id="HtWrapper.send_keys-197"><a href="#HtWrapper.send_keys-197"><span class="linenos">197</span></a><span class="sd">        {&quot;type&quot;: &quot;sendKeys&quot;, &quot;keys&quot;: [&quot;echo foo &amp;&amp; sleep 999&quot;, &quot;Enter&quot;]}</span>
</span><span id="HtWrapper.send_keys-198"><a href="#HtWrapper.send_keys-198"><span class="linenos">198</span></a><span class="sd">        ```</span>
</span><span id="HtWrapper.send_keys-199"><a href="#HtWrapper.send_keys-199"><span class="linenos">199</span></a>
</span><span id="HtWrapper.send_keys-200"><a href="#HtWrapper.send_keys-200"><span class="linenos">200</span></a><span class="sd">        Notice that Press.ENTER is still sent as &quot;Enter&quot; under the hood.</span>
</span><span id="HtWrapper.send_keys-201"><a href="#HtWrapper.send_keys-201"><span class="linenos">201</span></a><span class="sd">        `ht` checks to see if it corresponds with a known key and sends it letter-at-a-time if not.</span>
</span><span id="HtWrapper.send_keys-202"><a href="#HtWrapper.send_keys-202"><span class="linenos">202</span></a>
</span><span id="HtWrapper.send_keys-203"><a href="#HtWrapper.send_keys-203"><span class="linenos">203</span></a><span class="sd">        Because of this, you might run into suprises if you want to type individual characters which happen to spell out</span>
</span><span id="HtWrapper.send_keys-204"><a href="#HtWrapper.send_keys-204"><span class="linenos">204</span></a><span class="sd">        a known key such as &quot;Enter&quot; or &quot;Backspace&quot;.</span>
</span><span id="HtWrapper.send_keys-205"><a href="#HtWrapper.send_keys-205"><span class="linenos">205</span></a>
</span><span id="HtWrapper.send_keys-206"><a href="#HtWrapper.send_keys-206"><span class="linenos">206</span></a><span class="sd">        Work around this by breaking up the key names like so:</span>
</span><span id="HtWrapper.send_keys-207"><a href="#HtWrapper.send_keys-207"><span class="linenos">207</span></a>
</span><span id="HtWrapper.send_keys-208"><a href="#HtWrapper.send_keys-208"><span class="linenos">208</span></a><span class="sd">        ```python</span>
</span><span id="HtWrapper.send_keys-209"><a href="#HtWrapper.send_keys-209"><span class="linenos">209</span></a><span class="sd">        sh.send_keys([&quot;Ente&quot;, &quot;r&quot;])</span>
</span><span id="HtWrapper.send_keys-210"><a href="#HtWrapper.send_keys-210"><span class="linenos">210</span></a><span class="sd">        ```</span>
</span><span id="HtWrapper.send_keys-211"><a href="#HtWrapper.send_keys-211"><span class="linenos">211</span></a>
</span><span id="HtWrapper.send_keys-212"><a href="#HtWrapper.send_keys-212"><span class="linenos">212</span></a><span class="sd">        If this behavior is problematic for you, consider submitting an issue.</span>
</span><span id="HtWrapper.send_keys-213"><a href="#HtWrapper.send_keys-213"><span class="linenos">213</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper.send_keys-214"><a href="#HtWrapper.send_keys-214"><span class="linenos">214</span></a>        <span class="n">key_strings</span> <span class="o">=</span> <span class="n">keys_to_strings</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-215"><a href="#HtWrapper.send_keys-215"><span class="linenos">215</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sendKeys&quot;</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="n">key_strings</span><span class="p">})</span>
</span><span id="HtWrapper.send_keys-216"><a href="#HtWrapper.send_keys-216"><span class="linenos">216</span></a>
</span><span id="HtWrapper.send_keys-217"><a href="#HtWrapper.send_keys-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending keys: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-218"><a href="#HtWrapper.send_keys-218"><span class="linenos">218</span></a>
</span><span id="HtWrapper.send_keys-219"><a href="#HtWrapper.send_keys-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.send_keys-220"><a href="#HtWrapper.send_keys-220"><span class="linenos">220</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper.send_keys-221"><a href="#HtWrapper.send_keys-221"><span class="linenos">221</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-222"><a href="#HtWrapper.send_keys-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="HtWrapper.send_keys-223"><a href="#HtWrapper.send_keys-223"><span class="linenos">223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Keys sent successfully&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-224"><a href="#HtWrapper.send_keys-224"><span class="linenos">224</span></a>            <span class="k">except</span> <span class="p">(</span><span class="ne">BrokenPipeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper.send_keys-225"><a href="#HtWrapper.send_keys-225"><span class="linenos">225</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send keys: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-226"><a href="#HtWrapper.send_keys-226"><span class="linenos">226</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process poll result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-227"><a href="#HtWrapper.send_keys-227"><span class="linenos">227</span></a>                <span class="k">raise</span>
</span><span id="HtWrapper.send_keys-228"><a href="#HtWrapper.send_keys-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper.send_keys-229"><a href="#HtWrapper.send_keys-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ht process stdin is None&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.send_keys-230"><a href="#HtWrapper.send_keys-230"><span class="linenos">230</span></a>
</span><span id="HtWrapper.send_keys-231"><a href="#HtWrapper.send_keys-231"><span class="linenos">231</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Send keys to the terminal.  Accepts strings, <code>Press</code> objects, and lists of strings or <code>Press</code> objects.
For keys that you can <code>Press</code>, see
<a href="https://github.com/MatrixManAtYrService/htty/blob/main/htty/src/htty/keys.py">keys.py</a>.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">htty</span><span class="w"> </span><span class="kn">import</span> <span class="n">Press</span><span class="p">,</span> <span class="n">terminal_session</span>

<span class="k">with</span> <span class="p">(</span>
    <span class="n">terminal_session</span><span class="p">(</span><span class="s2">&quot;sh -i&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">test_logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">sh</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s2">&quot;echo foo &amp;&amp; sleep 999&quot;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n"><a href="#Press.ENTER">Press.ENTER</a></span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;^foo&quot;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n"><a href="#Press.CTRL_Z">Press.CTRL_Z</a></span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;Stopped&quot;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">([</span><span class="s2">&quot;clear&quot;</span><span class="p">,</span> <span class="n"><a href="#Press.ENTER">Press.ENTER</a></span><span class="p">])</span>
</code></pre>
</div>

<p>These are sent to <code><a href="#HtWrapper.ht">ht</a></code> as events that look like this</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sendKeys&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;echo foo &amp;&amp; sleep 999&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Enter&quot;</span><span class="p">]}</span>
</code></pre>
</div>

<p>Notice that <a href="#Press.ENTER">Press.ENTER</a> is still sent as "Enter" under the hood.
<code><a href="#HtWrapper.ht">ht</a></code> checks to see if it corresponds with a known key and sends it letter-at-a-time if not.</p>

<p>Because of this, you might run into suprises if you want to type individual characters which happen to spell out
a known key such as "Enter" or "Backspace".</p>

<p>Work around this by breaking up the key names like so:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">sh</span><span class="o">.</span><span class="n">send_keys</span><span class="p">([</span><span class="s2">&quot;Ente&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">])</span>
</code></pre>
</div>

<p>If this behavior is problematic for you, consider submitting an issue.</p>
</div>


                            </div>
                            <div id="HtWrapper.snapshot" class="classattr">
                                        <input id="HtWrapper.snapshot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">snapshot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span></span><span class="return-annotation">) -> <span class="n"><a href="#SnapshotResult">SnapshotResult</a></span>:</span></span>

                <label class="view-source-button" for="HtWrapper.snapshot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper.snapshot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper.snapshot-233"><a href="#HtWrapper.snapshot-233"><span class="linenos">233</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_SNAPSHOT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotResult</span><span class="p">:</span>
</span><span id="HtWrapper.snapshot-234"><a href="#HtWrapper.snapshot-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper.snapshot-235"><a href="#HtWrapper.snapshot-235"><span class="linenos">235</span></a><span class="sd">        Take a snapshot of the terminal output.</span>
</span><span id="HtWrapper.snapshot-236"><a href="#HtWrapper.snapshot-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper.snapshot-237"><a href="#HtWrapper.snapshot-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.snapshot-238"><a href="#HtWrapper.snapshot-238"><span class="linenos">238</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process has exited with code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-239"><a href="#HtWrapper.snapshot-239"><span class="linenos">239</span></a>
</span><span id="HtWrapper.snapshot-240"><a href="#HtWrapper.snapshot-240"><span class="linenos">240</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;takeSnapshot&quot;</span><span class="p">})</span>
</span><span id="HtWrapper.snapshot-241"><a href="#HtWrapper.snapshot-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Taking snapshot: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-242"><a href="#HtWrapper.snapshot-242"><span class="linenos">242</span></a>
</span><span id="HtWrapper.snapshot-243"><a href="#HtWrapper.snapshot-243"><span class="linenos">243</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper.snapshot-244"><a href="#HtWrapper.snapshot-244"><span class="linenos">244</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.snapshot-245"><a href="#HtWrapper.snapshot-245"><span class="linenos">245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-246"><a href="#HtWrapper.snapshot-246"><span class="linenos">246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="HtWrapper.snapshot-247"><a href="#HtWrapper.snapshot-247"><span class="linenos">247</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Snapshot request sent successfully&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-248"><a href="#HtWrapper.snapshot-248"><span class="linenos">248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper.snapshot-249"><a href="#HtWrapper.snapshot-249"><span class="linenos">249</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ht process stdin is not available&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-250"><a href="#HtWrapper.snapshot-250"><span class="linenos">250</span></a>        <span class="k">except</span> <span class="ne">BrokenPipeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper.snapshot-251"><a href="#HtWrapper.snapshot-251"><span class="linenos">251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send snapshot request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-252"><a href="#HtWrapper.snapshot-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process poll result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-253"><a href="#HtWrapper.snapshot-253"><span class="linenos">253</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="HtWrapper.snapshot-254"><a href="#HtWrapper.snapshot-254"><span class="linenos">254</span></a>                <span class="sa">f</span><span class="s2">&quot;Cannot communicate with ht process (broken pipe). &quot;</span>
</span><span id="HtWrapper.snapshot-255"><a href="#HtWrapper.snapshot-255"><span class="linenos">255</span></a>                <span class="sa">f</span><span class="s2">&quot;Process may have exited. Poll result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="HtWrapper.snapshot-256"><a href="#HtWrapper.snapshot-256"><span class="linenos">256</span></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper.snapshot-257"><a href="#HtWrapper.snapshot-257"><span class="linenos">257</span></a>
</span><span id="HtWrapper.snapshot-258"><a href="#HtWrapper.snapshot-258"><span class="linenos">258</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DEFAULT_SLEEP_AFTER_KEYS</span><span class="p">)</span>
</span><span id="HtWrapper.snapshot-259"><a href="#HtWrapper.snapshot-259"><span class="linenos">259</span></a>
</span><span id="HtWrapper.snapshot-260"><a href="#HtWrapper.snapshot-260"><span class="linenos">260</span></a>        <span class="c1"># Use tenacity to retry getting the snapshot</span>
</span><span id="HtWrapper.snapshot-261"><a href="#HtWrapper.snapshot-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_snapshot</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Take a snapshot of the terminal output.</p>
</div>


                            </div>
                            <div id="HtWrapper.exit" class="classattr">
                                        <input id="HtWrapper.exit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">exit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="HtWrapper.exit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper.exit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper.exit-322"><a href="#HtWrapper.exit-322"><span class="linenos">322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_EXIT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="HtWrapper.exit-323"><a href="#HtWrapper.exit-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper.exit-324"><a href="#HtWrapper.exit-324"><span class="linenos">324</span></a><span class="sd">        Exit the ht process, ensuring clean shutdown.</span>
</span><span id="HtWrapper.exit-325"><a href="#HtWrapper.exit-325"><span class="linenos">325</span></a>
</span><span id="HtWrapper.exit-326"><a href="#HtWrapper.exit-326"><span class="linenos">326</span></a><span class="sd">        Uses different strategies based on subprocess state:</span>
</span><span id="HtWrapper.exit-327"><a href="#HtWrapper.exit-327"><span class="linenos">327</span></a><span class="sd">        - If subprocess already exited (exitCode event received): graceful shutdown via exit command</span>
</span><span id="HtWrapper.exit-328"><a href="#HtWrapper.exit-328"><span class="linenos">328</span></a><span class="sd">        - If subprocess still running: forced termination with SIGTERM then SIGKILL</span>
</span><span id="HtWrapper.exit-329"><a href="#HtWrapper.exit-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper.exit-330"><a href="#HtWrapper.exit-330"><span class="linenos">330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exiting HTProcess: ht_proc.pid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.exit-331"><a href="#HtWrapper.exit-331"><span class="linenos">331</span></a>
</span><span id="HtWrapper.exit-332"><a href="#HtWrapper.exit-332"><span class="linenos">332</span></a>        <span class="c1"># Check if we&#39;ve already received the exitCode event</span>
</span><span id="HtWrapper.exit-333"><a href="#HtWrapper.exit-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span><span class="p">:</span>
</span><span id="HtWrapper.exit-334"><a href="#HtWrapper.exit-334"><span class="linenos">334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess already exited (exitCode event received), attempting graceful shutdown&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.exit-335"><a href="#HtWrapper.exit-335"><span class="linenos">335</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graceful_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper.exit-336"><a href="#HtWrapper.exit-336"><span class="linenos">336</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HtWrapper.exit-337"><a href="#HtWrapper.exit-337"><span class="linenos">337</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess has not exited yet, checking current state&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.exit-338"><a href="#HtWrapper.exit-338"><span class="linenos">338</span></a>
</span><span id="HtWrapper.exit-339"><a href="#HtWrapper.exit-339"><span class="linenos">339</span></a>            <span class="c1"># Give a brief moment for any pending exitCode event to arrive</span>
</span><span id="HtWrapper.exit-340"><a href="#HtWrapper.exit-340"><span class="linenos">340</span></a>            <span class="n">brief_wait_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper.exit-341"><a href="#HtWrapper.exit-341"><span class="linenos">341</span></a>            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">brief_wait_start</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Wait up to 500ms</span>
</span><span id="HtWrapper.exit-342"><a href="#HtWrapper.exit-342"><span class="linenos">342</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess_exited</span><span class="p">:</span>
</span><span id="HtWrapper.exit-343"><a href="#HtWrapper.exit-343"><span class="linenos">343</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess exited during brief wait, attempting graceful shutdown&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.exit-344"><a href="#HtWrapper.exit-344"><span class="linenos">344</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graceful_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="HtWrapper.exit-345"><a href="#HtWrapper.exit-345"><span class="linenos">345</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="HtWrapper.exit-346"><a href="#HtWrapper.exit-346"><span class="linenos">346</span></a>
</span><span id="HtWrapper.exit-347"><a href="#HtWrapper.exit-347"><span class="linenos">347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subprocess still running after brief wait, using forced termination&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.exit-348"><a href="#HtWrapper.exit-348"><span class="linenos">348</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forced_exit</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Exit the ht process, ensuring clean shutdown.</p>

<p>Uses different strategies based on subprocess state:</p>

<ul>
<li>If subprocess already exited (exitCode event received): graceful shutdown via exit command</li>
<li>If subprocess still running: forced termination with SIGTERM then SIGKILL</li>
</ul>
</div>


                            </div>
                            <div id="HtWrapper.expect" class="classattr">
                                        <input id="HtWrapper.expect-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">expect</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HtWrapper.expect-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper.expect"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper.expect-454"><a href="#HtWrapper.expect-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_EXPECT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.expect-455"><a href="#HtWrapper.expect-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper.expect-456"><a href="#HtWrapper.expect-456"><span class="linenos">456</span></a><span class="sd">        Wait for a regex pattern to appear in the terminal output.</span>
</span><span id="HtWrapper.expect-457"><a href="#HtWrapper.expect-457"><span class="linenos">457</span></a>
</span><span id="HtWrapper.expect-458"><a href="#HtWrapper.expect-458"><span class="linenos">458</span></a><span class="sd">        This method efficiently waits for output by monitoring the output events from</span>
</span><span id="HtWrapper.expect-459"><a href="#HtWrapper.expect-459"><span class="linenos">459</span></a><span class="sd">        the ht process rather than polling with snapshots. It checks both the current</span>
</span><span id="HtWrapper.expect-460"><a href="#HtWrapper.expect-460"><span class="linenos">460</span></a><span class="sd">        terminal state (via snapshot) and any new output that arrives.</span>
</span><span id="HtWrapper.expect-461"><a href="#HtWrapper.expect-461"><span class="linenos">461</span></a>
</span><span id="HtWrapper.expect-462"><a href="#HtWrapper.expect-462"><span class="linenos">462</span></a><span class="sd">        Args:</span>
</span><span id="HtWrapper.expect-463"><a href="#HtWrapper.expect-463"><span class="linenos">463</span></a><span class="sd">            pattern: The regex pattern to look for in the terminal output</span>
</span><span id="HtWrapper.expect-464"><a href="#HtWrapper.expect-464"><span class="linenos">464</span></a><span class="sd">            timeout: Maximum time to wait in seconds (default: 5.0)</span>
</span><span id="HtWrapper.expect-465"><a href="#HtWrapper.expect-465"><span class="linenos">465</span></a>
</span><span id="HtWrapper.expect-466"><a href="#HtWrapper.expect-466"><span class="linenos">466</span></a><span class="sd">        Raises:</span>
</span><span id="HtWrapper.expect-467"><a href="#HtWrapper.expect-467"><span class="linenos">467</span></a><span class="sd">            TimeoutError: If the pattern doesn&#39;t appear within the timeout period</span>
</span><span id="HtWrapper.expect-468"><a href="#HtWrapper.expect-468"><span class="linenos">468</span></a><span class="sd">            RuntimeError: If the ht process has exited</span>
</span><span id="HtWrapper.expect-469"><a href="#HtWrapper.expect-469"><span class="linenos">469</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper.expect-470"><a href="#HtWrapper.expect-470"><span class="linenos">470</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.expect-471"><a href="#HtWrapper.expect-471"><span class="linenos">471</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process has exited with code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-472"><a href="#HtWrapper.expect-472"><span class="linenos">472</span></a>
</span><span id="HtWrapper.expect-473"><a href="#HtWrapper.expect-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting regex pattern: &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-474"><a href="#HtWrapper.expect-474"><span class="linenos">474</span></a>
</span><span id="HtWrapper.expect-475"><a href="#HtWrapper.expect-475"><span class="linenos">475</span></a>        <span class="c1"># Compile the regex pattern</span>
</span><span id="HtWrapper.expect-476"><a href="#HtWrapper.expect-476"><span class="linenos">476</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper.expect-477"><a href="#HtWrapper.expect-477"><span class="linenos">477</span></a>            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span id="HtWrapper.expect-478"><a href="#HtWrapper.expect-478"><span class="linenos">478</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper.expect-479"><a href="#HtWrapper.expect-479"><span class="linenos">479</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper.expect-480"><a href="#HtWrapper.expect-480"><span class="linenos">480</span></a>
</span><span id="HtWrapper.expect-481"><a href="#HtWrapper.expect-481"><span class="linenos">481</span></a>        <span class="c1"># First check current terminal state</span>
</span><span id="HtWrapper.expect-482"><a href="#HtWrapper.expect-482"><span class="linenos">482</span></a>        <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</span><span id="HtWrapper.expect-483"><a href="#HtWrapper.expect-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span id="HtWrapper.expect-484"><a href="#HtWrapper.expect-484"><span class="linenos">484</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found immediately in current terminal state&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-485"><a href="#HtWrapper.expect-485"><span class="linenos">485</span></a>            <span class="k">return</span>
</span><span id="HtWrapper.expect-486"><a href="#HtWrapper.expect-486"><span class="linenos">486</span></a>
</span><span id="HtWrapper.expect-487"><a href="#HtWrapper.expect-487"><span class="linenos">487</span></a>        <span class="c1"># Start time for timeout tracking</span>
</span><span id="HtWrapper.expect-488"><a href="#HtWrapper.expect-488"><span class="linenos">488</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper.expect-489"><a href="#HtWrapper.expect-489"><span class="linenos">489</span></a>
</span><span id="HtWrapper.expect-490"><a href="#HtWrapper.expect-490"><span class="linenos">490</span></a>        <span class="c1"># Process events until we find the pattern or timeout</span>
</span><span id="HtWrapper.expect-491"><a href="#HtWrapper.expect-491"><span class="linenos">491</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="HtWrapper.expect-492"><a href="#HtWrapper.expect-492"><span class="linenos">492</span></a>            <span class="c1"># Check timeout</span>
</span><span id="HtWrapper.expect-493"><a href="#HtWrapper.expect-493"><span class="linenos">493</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper.expect-494"><a href="#HtWrapper.expect-494"><span class="linenos">494</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; not found in terminal output after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-495"><a href="#HtWrapper.expect-495"><span class="linenos">495</span></a>                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; not found within </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-496"><a href="#HtWrapper.expect-496"><span class="linenos">496</span></a>
</span><span id="HtWrapper.expect-497"><a href="#HtWrapper.expect-497"><span class="linenos">497</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper.expect-498"><a href="#HtWrapper.expect-498"><span class="linenos">498</span></a>                <span class="c1"># Wait for next event with a short timeout to allow checking the overall timeout</span>
</span><span id="HtWrapper.expect-499"><a href="#HtWrapper.expect-499"><span class="linenos">499</span></a>                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="HtWrapper.expect-500"><a href="#HtWrapper.expect-500"><span class="linenos">500</span></a>            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="HtWrapper.expect-501"><a href="#HtWrapper.expect-501"><span class="linenos">501</span></a>                <span class="k">continue</span>
</span><span id="HtWrapper.expect-502"><a href="#HtWrapper.expect-502"><span class="linenos">502</span></a>
</span><span id="HtWrapper.expect-503"><a href="#HtWrapper.expect-503"><span class="linenos">503</span></a>            <span class="c1"># Process the event</span>
</span><span id="HtWrapper.expect-504"><a href="#HtWrapper.expect-504"><span class="linenos">504</span></a>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
</span><span id="HtWrapper.expect-505"><a href="#HtWrapper.expect-505"><span class="linenos">505</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper.expect-506"><a href="#HtWrapper.expect-506"><span class="linenos">506</span></a>                <span class="c1"># Check if pattern appears in this output</span>
</span><span id="HtWrapper.expect-507"><a href="#HtWrapper.expect-507"><span class="linenos">507</span></a>                <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">&quot;seq&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;seq&quot;</span><span class="p">]):</span>
</span><span id="HtWrapper.expect-508"><a href="#HtWrapper.expect-508"><span class="linenos">508</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in output event&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-509"><a href="#HtWrapper.expect-509"><span class="linenos">509</span></a>                    <span class="k">return</span>
</span><span id="HtWrapper.expect-510"><a href="#HtWrapper.expect-510"><span class="linenos">510</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;exitCode&quot;</span><span class="p">:</span>
</span><span id="HtWrapper.expect-511"><a href="#HtWrapper.expect-511"><span class="linenos">511</span></a>                <span class="c1"># Put back in queue for reader thread to handle</span>
</span><span id="HtWrapper.expect-512"><a href="#HtWrapper.expect-512"><span class="linenos">512</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper.expect-513"><a href="#HtWrapper.expect-513"><span class="linenos">513</span></a>                <span class="c1"># Don&#39;t raise here - the process might have exited after outputting what we want</span>
</span><span id="HtWrapper.expect-514"><a href="#HtWrapper.expect-514"><span class="linenos">514</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span>
</span><span id="HtWrapper.expect-515"><a href="#HtWrapper.expect-515"><span class="linenos">515</span></a>                <span class="c1"># If we get a snapshot event, check its content</span>
</span><span id="HtWrapper.expect-516"><a href="#HtWrapper.expect-516"><span class="linenos">516</span></a>                <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]):</span>
</span><span id="HtWrapper.expect-517"><a href="#HtWrapper.expect-517"><span class="linenos">517</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in snapshot event&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-518"><a href="#HtWrapper.expect-518"><span class="linenos">518</span></a>                    <span class="k">return</span>
</span><span id="HtWrapper.expect-519"><a href="#HtWrapper.expect-519"><span class="linenos">519</span></a>
</span><span id="HtWrapper.expect-520"><a href="#HtWrapper.expect-520"><span class="linenos">520</span></a>            <span class="c1"># Take a new snapshot periodically to catch any missed output</span>
</span><span id="HtWrapper.expect-521"><a href="#HtWrapper.expect-521"><span class="linenos">521</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Every 10 events</span>
</span><span id="HtWrapper.expect-522"><a href="#HtWrapper.expect-522"><span class="linenos">522</span></a>                <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</span><span id="HtWrapper.expect-523"><a href="#HtWrapper.expect-523"><span class="linenos">523</span></a>                <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span id="HtWrapper.expect-524"><a href="#HtWrapper.expect-524"><span class="linenos">524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in periodic snapshot&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect-525"><a href="#HtWrapper.expect-525"><span class="linenos">525</span></a>                    <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Wait for a regex pattern to appear in the terminal output.</p>

<p>This method efficiently waits for output by monitoring the output events from
the ht process rather than polling with snapshots. It checks both the current
terminal state (via snapshot) and any new output that arrives.</p>

<p>Args:
    pattern: The regex pattern to look for in the terminal output
    timeout: Maximum time to wait in seconds (default: 5.0)</p>

<p>Raises:
    TimeoutError: If the pattern doesn't appear within the timeout period
    RuntimeError: If the ht process has exited</p>
</div>


                            </div>
                            <div id="HtWrapper.expect_absent" class="classattr">
                                        <input id="HtWrapper.expect_absent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">expect_absent</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HtWrapper.expect_absent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HtWrapper.expect_absent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HtWrapper.expect_absent-527"><a href="#HtWrapper.expect_absent-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expect_absent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_EXPECT_TIMEOUT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-528"><a href="#HtWrapper.expect_absent-528"><span class="linenos">528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HtWrapper.expect_absent-529"><a href="#HtWrapper.expect_absent-529"><span class="linenos">529</span></a><span class="sd">        Wait for a regex pattern to disappear from the terminal output.</span>
</span><span id="HtWrapper.expect_absent-530"><a href="#HtWrapper.expect_absent-530"><span class="linenos">530</span></a>
</span><span id="HtWrapper.expect_absent-531"><a href="#HtWrapper.expect_absent-531"><span class="linenos">531</span></a><span class="sd">        This method efficiently waits for output changes by monitoring the output events</span>
</span><span id="HtWrapper.expect_absent-532"><a href="#HtWrapper.expect_absent-532"><span class="linenos">532</span></a><span class="sd">        from the ht process rather than polling with snapshots. It periodically checks</span>
</span><span id="HtWrapper.expect_absent-533"><a href="#HtWrapper.expect_absent-533"><span class="linenos">533</span></a><span class="sd">        the terminal state to verify the pattern is gone.</span>
</span><span id="HtWrapper.expect_absent-534"><a href="#HtWrapper.expect_absent-534"><span class="linenos">534</span></a>
</span><span id="HtWrapper.expect_absent-535"><a href="#HtWrapper.expect_absent-535"><span class="linenos">535</span></a><span class="sd">        Args:</span>
</span><span id="HtWrapper.expect_absent-536"><a href="#HtWrapper.expect_absent-536"><span class="linenos">536</span></a><span class="sd">            pattern: The regex pattern that should disappear from the terminal output</span>
</span><span id="HtWrapper.expect_absent-537"><a href="#HtWrapper.expect_absent-537"><span class="linenos">537</span></a><span class="sd">            timeout: Maximum time to wait in seconds (default: 5.0)</span>
</span><span id="HtWrapper.expect_absent-538"><a href="#HtWrapper.expect_absent-538"><span class="linenos">538</span></a>
</span><span id="HtWrapper.expect_absent-539"><a href="#HtWrapper.expect_absent-539"><span class="linenos">539</span></a><span class="sd">        Raises:</span>
</span><span id="HtWrapper.expect_absent-540"><a href="#HtWrapper.expect_absent-540"><span class="linenos">540</span></a><span class="sd">            TimeoutError: If the pattern doesn&#39;t disappear within the timeout period</span>
</span><span id="HtWrapper.expect_absent-541"><a href="#HtWrapper.expect_absent-541"><span class="linenos">541</span></a><span class="sd">            RuntimeError: If the ht process has exited</span>
</span><span id="HtWrapper.expect_absent-542"><a href="#HtWrapper.expect_absent-542"><span class="linenos">542</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HtWrapper.expect_absent-543"><a href="#HtWrapper.expect_absent-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-544"><a href="#HtWrapper.expect_absent-544"><span class="linenos">544</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ht process has exited with code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht_proc</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-545"><a href="#HtWrapper.expect_absent-545"><span class="linenos">545</span></a>
</span><span id="HtWrapper.expect_absent-546"><a href="#HtWrapper.expect_absent-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting regex pattern to disappear: &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-547"><a href="#HtWrapper.expect_absent-547"><span class="linenos">547</span></a>
</span><span id="HtWrapper.expect_absent-548"><a href="#HtWrapper.expect_absent-548"><span class="linenos">548</span></a>        <span class="c1"># Compile the regex pattern</span>
</span><span id="HtWrapper.expect_absent-549"><a href="#HtWrapper.expect_absent-549"><span class="linenos">549</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-550"><a href="#HtWrapper.expect_absent-550"><span class="linenos">550</span></a>            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-551"><a href="#HtWrapper.expect_absent-551"><span class="linenos">551</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-552"><a href="#HtWrapper.expect_absent-552"><span class="linenos">552</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="HtWrapper.expect_absent-553"><a href="#HtWrapper.expect_absent-553"><span class="linenos">553</span></a>
</span><span id="HtWrapper.expect_absent-554"><a href="#HtWrapper.expect_absent-554"><span class="linenos">554</span></a>        <span class="c1"># Start time for timeout tracking</span>
</span><span id="HtWrapper.expect_absent-555"><a href="#HtWrapper.expect_absent-555"><span class="linenos">555</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="HtWrapper.expect_absent-556"><a href="#HtWrapper.expect_absent-556"><span class="linenos">556</span></a>
</span><span id="HtWrapper.expect_absent-557"><a href="#HtWrapper.expect_absent-557"><span class="linenos">557</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-558"><a href="#HtWrapper.expect_absent-558"><span class="linenos">558</span></a>            <span class="c1"># Take a snapshot to check current state</span>
</span><span id="HtWrapper.expect_absent-559"><a href="#HtWrapper.expect_absent-559"><span class="linenos">559</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</span><span id="HtWrapper.expect_absent-560"><a href="#HtWrapper.expect_absent-560"><span class="linenos">560</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span id="HtWrapper.expect_absent-561"><a href="#HtWrapper.expect_absent-561"><span class="linenos">561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; is now absent from terminal output&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-562"><a href="#HtWrapper.expect_absent-562"><span class="linenos">562</span></a>                <span class="k">return</span>
</span><span id="HtWrapper.expect_absent-563"><a href="#HtWrapper.expect_absent-563"><span class="linenos">563</span></a>
</span><span id="HtWrapper.expect_absent-564"><a href="#HtWrapper.expect_absent-564"><span class="linenos">564</span></a>            <span class="c1"># Check timeout</span>
</span><span id="HtWrapper.expect_absent-565"><a href="#HtWrapper.expect_absent-565"><span class="linenos">565</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-566"><a href="#HtWrapper.expect_absent-566"><span class="linenos">566</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; still present in terminal output after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-567"><a href="#HtWrapper.expect_absent-567"><span class="linenos">567</span></a>                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; still present after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-568"><a href="#HtWrapper.expect_absent-568"><span class="linenos">568</span></a>
</span><span id="HtWrapper.expect_absent-569"><a href="#HtWrapper.expect_absent-569"><span class="linenos">569</span></a>            <span class="c1"># Wait for next event with a short timeout</span>
</span><span id="HtWrapper.expect_absent-570"><a href="#HtWrapper.expect_absent-570"><span class="linenos">570</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-571"><a href="#HtWrapper.expect_absent-571"><span class="linenos">571</span></a>                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-572"><a href="#HtWrapper.expect_absent-572"><span class="linenos">572</span></a>            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-573"><a href="#HtWrapper.expect_absent-573"><span class="linenos">573</span></a>                <span class="k">continue</span>
</span><span id="HtWrapper.expect_absent-574"><a href="#HtWrapper.expect_absent-574"><span class="linenos">574</span></a>
</span><span id="HtWrapper.expect_absent-575"><a href="#HtWrapper.expect_absent-575"><span class="linenos">575</span></a>            <span class="c1"># Process the event</span>
</span><span id="HtWrapper.expect_absent-576"><a href="#HtWrapper.expect_absent-576"><span class="linenos">576</span></a>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-577"><a href="#HtWrapper.expect_absent-577"><span class="linenos">577</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_output_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-578"><a href="#HtWrapper.expect_absent-578"><span class="linenos">578</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;exitCode&quot;</span><span class="p">:</span>
</span><span id="HtWrapper.expect_absent-579"><a href="#HtWrapper.expect_absent-579"><span class="linenos">579</span></a>                <span class="c1"># Put back in queue for reader thread to handle</span>
</span><span id="HtWrapper.expect_absent-580"><a href="#HtWrapper.expect_absent-580"><span class="linenos">580</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="HtWrapper.expect_absent-581"><a href="#HtWrapper.expect_absent-581"><span class="linenos">581</span></a>                <span class="c1"># Don&#39;t raise here - the process might have exited after the pattern disappeared</span>
</span></pre></div>


            <div class="docstring"><p>Wait for a regex pattern to disappear from the terminal output.</p>

<p>This method efficiently waits for output changes by monitoring the output events
from the ht process rather than polling with snapshots. It periodically checks
the terminal state to verify the pattern is gone.</p>

<p>Args:
    pattern: The regex pattern that should disappear from the terminal output
    timeout: Maximum time to wait in seconds (default: 5.0)</p>

<p>Raises:
    TimeoutError: If the pattern doesn't disappear within the timeout period
    RuntimeError: If the ht process has exited</p>
</div>


                            </div>
                </section>
                <section id="ProcessController">
                            <input id="ProcessController-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ProcessController</span><wbr>(<span class="base">typing.Protocol</span>):

                <label class="view-source-button" for="ProcessController-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController-20"><a href="#ProcessController-20"><span class="linenos">20</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ProcessController</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span id="ProcessController-21"><a href="#ProcessController-21"><span class="linenos">21</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for process manipulation operations.&quot;&quot;&quot;</span>
</span><span id="ProcessController-22"><a href="#ProcessController-22"><span class="linenos">22</span></a>
</span><span id="ProcessController-23"><a href="#ProcessController-23"><span class="linenos">23</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ProcessController-24"><a href="#ProcessController-24"><span class="linenos">24</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController-25"><a href="#ProcessController-25"><span class="linenos">25</span></a>        <span class="o">...</span>
</span><span id="ProcessController-26"><a href="#ProcessController-26"><span class="linenos">26</span></a>
</span><span id="ProcessController-27"><a href="#ProcessController-27"><span class="linenos">27</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessController-28"><a href="#ProcessController-28"><span class="linenos">28</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminate the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController-29"><a href="#ProcessController-29"><span class="linenos">29</span></a>        <span class="o">...</span>
</span><span id="ProcessController-30"><a href="#ProcessController-30"><span class="linenos">30</span></a>
</span><span id="ProcessController-31"><a href="#ProcessController-31"><span class="linenos">31</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessController-32"><a href="#ProcessController-32"><span class="linenos">32</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Force kill the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController-33"><a href="#ProcessController-33"><span class="linenos">33</span></a>        <span class="o">...</span>
</span><span id="ProcessController-34"><a href="#ProcessController-34"><span class="linenos">34</span></a>
</span><span id="ProcessController-35"><a href="#ProcessController-35"><span class="linenos">35</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController-36"><a href="#ProcessController-36"><span class="linenos">36</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for the process to finish.&quot;&quot;&quot;</span>
</span><span id="ProcessController-37"><a href="#ProcessController-37"><span class="linenos">37</span></a>        <span class="o">...</span>
</span><span id="ProcessController-38"><a href="#ProcessController-38"><span class="linenos">38</span></a>
</span><span id="ProcessController-39"><a href="#ProcessController-39"><span class="linenos">39</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController-40"><a href="#ProcessController-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the process is still running.&quot;&quot;&quot;</span>
</span><span id="ProcessController-41"><a href="#ProcessController-41"><span class="linenos">41</span></a>        <span class="o">...</span>
</span><span id="ProcessController-42"><a href="#ProcessController-42"><span class="linenos">42</span></a>
</span><span id="ProcessController-43"><a href="#ProcessController-43"><span class="linenos">43</span></a>    <span class="nd">@property</span>
</span><span id="ProcessController-44"><a href="#ProcessController-44"><span class="linenos">44</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController-45"><a href="#ProcessController-45"><span class="linenos">45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the process ID.&quot;&quot;&quot;</span>
</span><span id="ProcessController-46"><a href="#ProcessController-46"><span class="linenos">46</span></a>        <span class="o">...</span>
</span><span id="ProcessController-47"><a href="#ProcessController-47"><span class="linenos">47</span></a>
</span><span id="ProcessController-48"><a href="#ProcessController-48"><span class="linenos">48</span></a>    <span class="nd">@pid</span><span class="o">.</span><span class="n">setter</span>
</span><span id="ProcessController-49"><a href="#ProcessController-49"><span class="linenos">49</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessController-50"><a href="#ProcessController-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the process ID.&quot;&quot;&quot;</span>
</span><span id="ProcessController-51"><a href="#ProcessController-51"><span class="linenos">51</span></a>        <span class="o">...</span>
</span><span id="ProcessController-52"><a href="#ProcessController-52"><span class="linenos">52</span></a>
</span><span id="ProcessController-53"><a href="#ProcessController-53"><span class="linenos">53</span></a>    <span class="nd">@property</span>
</span><span id="ProcessController-54"><a href="#ProcessController-54"><span class="linenos">54</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController-55"><a href="#ProcessController-55"><span class="linenos">55</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the exit code of the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController-56"><a href="#ProcessController-56"><span class="linenos">56</span></a>        <span class="o">...</span>
</span><span id="ProcessController-57"><a href="#ProcessController-57"><span class="linenos">57</span></a>
</span><span id="ProcessController-58"><a href="#ProcessController-58"><span class="linenos">58</span></a>    <span class="nd">@exit_code</span><span class="o">.</span><span class="n">setter</span>
</span><span id="ProcessController-59"><a href="#ProcessController-59"><span class="linenos">59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessController-60"><a href="#ProcessController-60"><span class="linenos">60</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the exit code of the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController-61"><a href="#ProcessController-61"><span class="linenos">61</span></a>        <span class="o">...</span>
</span><span id="ProcessController-62"><a href="#ProcessController-62"><span class="linenos">62</span></a>
</span><span id="ProcessController-63"><a href="#ProcessController-63"><span class="linenos">63</span></a>    <span class="nd">@property</span>
</span><span id="ProcessController-64"><a href="#ProcessController-64"><span class="linenos">64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">completed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="ProcessController-65"><a href="#ProcessController-65"><span class="linenos">65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the process has completed.&quot;&quot;&quot;</span>
</span><span id="ProcessController-66"><a href="#ProcessController-66"><span class="linenos">66</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Protocol for process manipulation operations.</p>
</div>


                            <div id="ProcessController.__init__" class="classattr">
                                        <input id="ProcessController.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ProcessController</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ProcessController.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.__init__-1771"><a href="#ProcessController.__init__-1771"><span class="linenos">1771</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_no_init_or_replace_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ProcessController.__init__-1772"><a href="#ProcessController.__init__-1772"><span class="linenos">1772</span></a>    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="ProcessController.__init__-1773"><a href="#ProcessController.__init__-1773"><span class="linenos">1773</span></a>
</span><span id="ProcessController.__init__-1774"><a href="#ProcessController.__init__-1774"><span class="linenos">1774</span></a>    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_protocol</span><span class="p">:</span>
</span><span id="ProcessController.__init__-1775"><a href="#ProcessController.__init__-1775"><span class="linenos">1775</span></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Protocols cannot be instantiated&#39;</span><span class="p">)</span>
</span><span id="ProcessController.__init__-1776"><a href="#ProcessController.__init__-1776"><span class="linenos">1776</span></a>
</span><span id="ProcessController.__init__-1777"><a href="#ProcessController.__init__-1777"><span class="linenos">1777</span></a>    <span class="c1"># Already using a custom `__init__`. No need to calculate correct</span>
</span><span id="ProcessController.__init__-1778"><a href="#ProcessController.__init__-1778"><span class="linenos">1778</span></a>    <span class="c1"># `__init__` to call. This can lead to RecursionError. See bpo-45121.</span>
</span><span id="ProcessController.__init__-1779"><a href="#ProcessController.__init__-1779"><span class="linenos">1779</span></a>    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_no_init_or_replace_init</span><span class="p">:</span>
</span><span id="ProcessController.__init__-1780"><a href="#ProcessController.__init__-1780"><span class="linenos">1780</span></a>        <span class="k">return</span>
</span><span id="ProcessController.__init__-1781"><a href="#ProcessController.__init__-1781"><span class="linenos">1781</span></a>
</span><span id="ProcessController.__init__-1782"><a href="#ProcessController.__init__-1782"><span class="linenos">1782</span></a>    <span class="c1"># Initially, `__init__` of a protocol subclass is set to `_no_init_or_replace_init`.</span>
</span><span id="ProcessController.__init__-1783"><a href="#ProcessController.__init__-1783"><span class="linenos">1783</span></a>    <span class="c1"># The first instantiation of the subclass will call `_no_init_or_replace_init` which</span>
</span><span id="ProcessController.__init__-1784"><a href="#ProcessController.__init__-1784"><span class="linenos">1784</span></a>    <span class="c1"># searches for a proper new `__init__` in the MRO. The new `__init__`</span>
</span><span id="ProcessController.__init__-1785"><a href="#ProcessController.__init__-1785"><span class="linenos">1785</span></a>    <span class="c1"># replaces the subclass&#39; old `__init__` (ie `_no_init_or_replace_init`). Subsequent</span>
</span><span id="ProcessController.__init__-1786"><a href="#ProcessController.__init__-1786"><span class="linenos">1786</span></a>    <span class="c1"># instantiation of the protocol subclass will thus use the new</span>
</span><span id="ProcessController.__init__-1787"><a href="#ProcessController.__init__-1787"><span class="linenos">1787</span></a>    <span class="c1"># `__init__` and no longer call `_no_init_or_replace_init`.</span>
</span><span id="ProcessController.__init__-1788"><a href="#ProcessController.__init__-1788"><span class="linenos">1788</span></a>    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="ProcessController.__init__-1789"><a href="#ProcessController.__init__-1789"><span class="linenos">1789</span></a>        <span class="n">init</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__init__&#39;</span><span class="p">,</span> <span class="n">_no_init_or_replace_init</span><span class="p">)</span>
</span><span id="ProcessController.__init__-1790"><a href="#ProcessController.__init__-1790"><span class="linenos">1790</span></a>        <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_no_init_or_replace_init</span><span class="p">:</span>
</span><span id="ProcessController.__init__-1791"><a href="#ProcessController.__init__-1791"><span class="linenos">1791</span></a>            <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">init</span>
</span><span id="ProcessController.__init__-1792"><a href="#ProcessController.__init__-1792"><span class="linenos">1792</span></a>            <span class="k">break</span>
</span><span id="ProcessController.__init__-1793"><a href="#ProcessController.__init__-1793"><span class="linenos">1793</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessController.__init__-1794"><a href="#ProcessController.__init__-1794"><span class="linenos">1794</span></a>        <span class="c1"># should not happen</span>
</span><span id="ProcessController.__init__-1795"><a href="#ProcessController.__init__-1795"><span class="linenos">1795</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span>
</span><span id="ProcessController.__init__-1796"><a href="#ProcessController.__init__-1796"><span class="linenos">1796</span></a>
</span><span id="ProcessController.__init__-1797"><a href="#ProcessController.__init__-1797"><span class="linenos">1797</span></a>    <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ProcessController.exit" class="classattr">
                                        <input id="ProcessController.exit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">exit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="ProcessController.exit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.exit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.exit-23"><a href="#ProcessController.exit-23"><span class="linenos">23</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ProcessController.exit-24"><a href="#ProcessController.exit-24"><span class="linenos">24</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController.exit-25"><a href="#ProcessController.exit-25"><span class="linenos">25</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Exit the process.</p>
</div>


                            </div>
                            <div id="ProcessController.terminate" class="classattr">
                                        <input id="ProcessController.terminate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">terminate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="ProcessController.terminate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.terminate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.terminate-27"><a href="#ProcessController.terminate-27"><span class="linenos">27</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessController.terminate-28"><a href="#ProcessController.terminate-28"><span class="linenos">28</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminate the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController.terminate-29"><a href="#ProcessController.terminate-29"><span class="linenos">29</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Terminate the process.</p>
</div>


                            </div>
                            <div id="ProcessController.kill" class="classattr">
                                        <input id="ProcessController.kill-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kill</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="ProcessController.kill-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.kill"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.kill-31"><a href="#ProcessController.kill-31"><span class="linenos">31</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessController.kill-32"><a href="#ProcessController.kill-32"><span class="linenos">32</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Force kill the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController.kill-33"><a href="#ProcessController.kill-33"><span class="linenos">33</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Force kill the process.</p>
</div>


                            </div>
                            <div id="ProcessController.wait" class="classattr">
                                        <input id="ProcessController.wait-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ProcessController.wait-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.wait"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.wait-35"><a href="#ProcessController.wait-35"><span class="linenos">35</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController.wait-36"><a href="#ProcessController.wait-36"><span class="linenos">36</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for the process to finish.&quot;&quot;&quot;</span>
</span><span id="ProcessController.wait-37"><a href="#ProcessController.wait-37"><span class="linenos">37</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Wait for the process to finish.</p>
</div>


                            </div>
                            <div id="ProcessController.poll" class="classattr">
                                        <input id="ProcessController.poll-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">poll</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ProcessController.poll-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.poll"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.poll-39"><a href="#ProcessController.poll-39"><span class="linenos">39</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController.poll-40"><a href="#ProcessController.poll-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the process is still running.&quot;&quot;&quot;</span>
</span><span id="ProcessController.poll-41"><a href="#ProcessController.poll-41"><span class="linenos">41</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Check if the process is still running.</p>
</div>


                            </div>
                            <div id="ProcessController.pid" class="classattr">
                                        <input id="ProcessController.pid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">pid</span><span class="annotation">: Optional[int]</span>

                <label class="view-source-button" for="ProcessController.pid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.pid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.pid-43"><a href="#ProcessController.pid-43"><span class="linenos">43</span></a>    <span class="nd">@property</span>
</span><span id="ProcessController.pid-44"><a href="#ProcessController.pid-44"><span class="linenos">44</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController.pid-45"><a href="#ProcessController.pid-45"><span class="linenos">45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the process ID.&quot;&quot;&quot;</span>
</span><span id="ProcessController.pid-46"><a href="#ProcessController.pid-46"><span class="linenos">46</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Get the process ID.</p>
</div>


                            </div>
                            <div id="ProcessController.exit_code" class="classattr">
                                        <input id="ProcessController.exit_code-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">exit_code</span><span class="annotation">: Optional[int]</span>

                <label class="view-source-button" for="ProcessController.exit_code-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.exit_code"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.exit_code-53"><a href="#ProcessController.exit_code-53"><span class="linenos">53</span></a>    <span class="nd">@property</span>
</span><span id="ProcessController.exit_code-54"><a href="#ProcessController.exit_code-54"><span class="linenos">54</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="ProcessController.exit_code-55"><a href="#ProcessController.exit_code-55"><span class="linenos">55</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the exit code of the process.&quot;&quot;&quot;</span>
</span><span id="ProcessController.exit_code-56"><a href="#ProcessController.exit_code-56"><span class="linenos">56</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Get the exit code of the process.</p>
</div>


                            </div>
                            <div id="ProcessController.completed" class="classattr">
                                        <input id="ProcessController.completed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">completed</span><span class="annotation">: bool</span>

                <label class="view-source-button" for="ProcessController.completed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessController.completed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessController.completed-63"><a href="#ProcessController.completed-63"><span class="linenos">63</span></a>    <span class="nd">@property</span>
</span><span id="ProcessController.completed-64"><a href="#ProcessController.completed-64"><span class="linenos">64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">completed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="ProcessController.completed-65"><a href="#ProcessController.completed-65"><span class="linenos">65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the process has completed.&quot;&quot;&quot;</span>
</span><span id="ProcessController.completed-66"><a href="#ProcessController.completed-66"><span class="linenos">66</span></a>        <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Check if the process has completed.</p>
</div>


                            </div>
                </section>
                <section id="SnapshotResult">
                            <input id="SnapshotResult-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SnapshotResult</span>:

                <label class="view-source-button" for="SnapshotResult-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SnapshotResult"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SnapshotResult-68"><a href="#SnapshotResult-68"><span class="linenos">68</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SnapshotResult</span><span class="p">:</span>
</span><span id="SnapshotResult-69"><a href="#SnapshotResult-69"><span class="linenos">69</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of taking a terminal snapshot&quot;&quot;&quot;</span>
</span><span id="SnapshotResult-70"><a href="#SnapshotResult-70"><span class="linenos">70</span></a>
</span><span id="SnapshotResult-71"><a href="#SnapshotResult-71"><span class="linenos">71</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raw_seq</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SnapshotResult-72"><a href="#SnapshotResult-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
</span><span id="SnapshotResult-73"><a href="#SnapshotResult-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">html</span>
</span><span id="SnapshotResult-74"><a href="#SnapshotResult-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_seq</span> <span class="o">=</span> <span class="n">raw_seq</span>
</span><span id="SnapshotResult-75"><a href="#SnapshotResult-75"><span class="linenos">75</span></a>
</span><span id="SnapshotResult-76"><a href="#SnapshotResult-76"><span class="linenos">76</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SnapshotResult-77"><a href="#SnapshotResult-77"><span class="linenos">77</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;SnapshotResult(text=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">!r}</span><span class="s2">, html=&lt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&gt;, raw_seq=&lt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_seq</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&gt;)&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Result of taking a terminal snapshot</p>
</div>


                            <div id="SnapshotResult.__init__" class="classattr">
                                        <input id="SnapshotResult.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SnapshotResult</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">text</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">html</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">raw_seq</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="SnapshotResult.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SnapshotResult.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SnapshotResult.__init__-71"><a href="#SnapshotResult.__init__-71"><span class="linenos">71</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raw_seq</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SnapshotResult.__init__-72"><a href="#SnapshotResult.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
</span><span id="SnapshotResult.__init__-73"><a href="#SnapshotResult.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">html</span>
</span><span id="SnapshotResult.__init__-74"><a href="#SnapshotResult.__init__-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_seq</span> <span class="o">=</span> <span class="n">raw_seq</span>
</span></pre></div>


    

                            </div>
                            <div id="SnapshotResult.text" class="classattr">
                                <div class="attr variable">
            <span class="name">text</span>

        
    </div>
    <a class="headerlink" href="#SnapshotResult.text"></a>
    
    

                            </div>
                            <div id="SnapshotResult.html" class="classattr">
                                <div class="attr variable">
            <span class="name">html</span>

        
    </div>
    <a class="headerlink" href="#SnapshotResult.html"></a>
    
    

                            </div>
                            <div id="SnapshotResult.raw_seq" class="classattr">
                                <div class="attr variable">
            <span class="name">raw_seq</span>

        
    </div>
    <a class="headerlink" href="#SnapshotResult.raw_seq"></a>
    
    

                            </div>
                </section>
                <section id="__version__">
                    <div class="attr variable">
            <span class="name">__version__</span>        =
<span class="default_value">&#39;0.2.28&#39;</span>

        
    </div>
    <a class="headerlink" href="#__version__"></a>
    
    

                </section>
    </main>
</body>
</html>