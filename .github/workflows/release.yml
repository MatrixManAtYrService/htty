name: Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Perform a dry run (build packages but do not publish)'
        type: boolean
        default: false

jobs:
  build-htty-core-wheels:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu

          # macOS builds
          - os: macos-13  # Intel
            target: x86_64-apple-darwin
          - os: macos-latest  # ARM64
            target: aarch64-apple-darwin

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build htty-core wheel
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --manifest-path htty-core/Cargo.toml
          sccache: 'true'
          manylinux: ${{ contains(matrix.target, 'linux') && '2_17' || 'auto' }}

      - name: Setup Python 3.10
        # Skip cross-compiled aarch64 builds on x86_64 runners  
        if: matrix.target != 'aarch64-unknown-linux-gnu'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Test wheel installation (native builds only)
        # Skip cross-compiled aarch64 builds on x86_64 runners
        if: matrix.target != 'aarch64-unknown-linux-gnu'
        run: |
          echo "üß™ Testing htty-core wheel installation and functionality"
          WHEEL_PATH=$(ls dist/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_PATH")
          
          echo "üì¶ Installing wheel: $WHEEL_NAME"
          
          # Create a clean Python environment for testing wheel installation
          python -m venv test_env
          source test_env/bin/activate
          
          # Install and test the wheel
          pip install --force-reinstall --verbose "$WHEEL_PATH"
          
          echo "üîß Testing Python import..."
          python -c "import htty_core; print('‚úÖ htty_core import successful')"
          
          echo "üîß Testing binary availability..."
          python -c "import htty_core; print(f'‚úÖ Binary path: {htty_core.find_ht_binary()}')"
          
          # Clean up
          deactivate
          rm -rf test_env
          
          echo "üéâ htty-core wheel testing complete!"

      - name: Upload htty-core wheel
        uses: actions/upload-artifact@v4
        with:
          name: htty-core-wheel-${{ matrix.target }}
          path: "dist/*.whl"

  build-htty-sdist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nix
        uses: ./.github/actions/setup-nix

      - name: Build htty source distribution
        run: |
          echo "üì¶ Building htty source distribution"
          nix build .#htty-sdist
          
          # Copy sdist to dist directory
          mkdir -p dist
          cp result/*.tar.gz dist/
          
          echo "üì¶ Built source distribution:"
          ls -la dist/

      - name: Upload htty sdist
        uses: actions/upload-artifact@v4
        with:
          name: htty-sdist
          path: "dist/*.tar.gz"

  publish-to-pypi:
    needs: [build-htty-core-wheels, build-htty-sdist]
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write  # For trusted publishing
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nix
        uses: ./.github/actions/setup-nix

      - name: Create packages directory
        run: mkdir -p packages/

      - name: Download all htty-core wheels
        uses: actions/download-artifact@v4
        with:
          pattern: htty-core-wheel-*
          path: packages/
          merge-multiple: true

      - name: Download htty source distribution
        uses: actions/download-artifact@v4
        with:
          name: htty-sdist
          path: packages/

      - name: Verify packages for publication
        run: |
          echo "üì¶ Packages to be published:"
          ls -la packages/
          
          # Count packages
          HTTY_CORE_WHEELS=$(ls packages/htty_core-*.whl 2>/dev/null | wc -l)
          HTTY_SDIST=$(ls packages/htty-*.tar.gz 2>/dev/null | wc -l)
          
          echo "   htty-core wheels: $HTTY_CORE_WHEELS"
          echo "   htty source distributions: $HTTY_SDIST"
          
          # Verify we have expected packages
          if [ "$HTTY_CORE_WHEELS" -eq 0 ]; then
            echo "‚ùå ERROR: No htty-core wheels found"
            exit 1
          fi
          
          if [ "$HTTY_SDIST" -eq 0 ]; then
            echo "‚ùå ERROR: No htty source distribution found"
            exit 1
          fi
          
          # Expected: 4 htty-core wheels (x86_64-linux, aarch64-linux, x86_64-darwin, aarch64-darwin)
          if [ "$HTTY_CORE_WHEELS" -ne 4 ]; then
            echo "‚ö†Ô∏è  WARNING: Expected 4 htty-core wheels, found $HTTY_CORE_WHEELS"
          fi
          
          # Expected: 1 htty source distribution
          if [ "$HTTY_SDIST" -ne 1 ]; then
            echo "‚ö†Ô∏è  WARNING: Expected 1 htty source distribution, found $HTTY_SDIST"
          fi
          
          echo "‚úÖ Package verification complete"
          
          # Show package details
          echo "üìã Package details:"
          for pkg in packages/*; do
            echo "  $(basename "$pkg") - $(ls -lh "$pkg" | awk '{print $5}')"
          done

      - name: Publish to PyPI
        if: ${{ !inputs.dry-run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Dry run complete
        if: ${{ inputs.dry-run }}
        run: |
          echo "üèÅ Dry run complete - packages built but not published"
          echo ""
          echo "üì¶ Built packages:"
          ls -la packages/
          echo ""
          echo "To publish for real, create a release tag or run workflow without dry-run"
